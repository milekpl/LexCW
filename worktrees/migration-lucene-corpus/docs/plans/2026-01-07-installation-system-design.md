# Installation System Design Document

**Date:** 2026-01-07
**Author:** Claude Code
**Status:** Design - Pending Implementation

---

## Overview

Design a systematic installation process for the Lexicographic Curation Workbench with comprehensive documentation and automation scripts. The goal is to enable new administrators to set up the application with minimal friction.

## Goals

1. Provide a single entry point for new administrators
2. Support Docker-first deployment (recommended) with hybrid mode as option
3. Automate prerequisite checking, configuration, and service initialization
4. Create comprehensive documentation that stays current
5. Enable both interactive and automated (CI/CD) installation

## Non-Goals

- Production Kubernetes deployment (out of scope)
- Windows native installation (only WSL/Docker on Windows)
- Migration from existing installations

---

## Deliverables

| File | Description |
|------|-------------|
| `INSTALL.md` | Quick start guide (landing page for new admins) |
| `docs/setup-guide.md` | Comprehensive setup documentation |
| `scripts/setup.sh` | Main setup orchestration script |
| `scripts/init-postgres.sh` | PostgreSQL initialization script |
| `scripts/download-basex.sh` | BaseX download script (hybrid mode) |
| `scripts/verify-setup.sh` | Service health verification script |

---

## Architecture

### Document Structure

```
flask-app/
├── INSTALL.md                      # Quick start guide
├── docs/
│   └── setup-guide.md              # Comprehensive guide
├── scripts/
│   ├── setup.sh                    # Main setup script
│   ├── init-postgres.sh            # PostgreSQL initialization
│   ├── download-basex.sh           # BaseX download
│   └── verify-setup.sh             # Health checks
├── .env.example                    # Already exists
├── .env                            # Generated by setup.sh
├── sql/
│   └── init.sql                    # Already exists
├── docker-compose.yml              # Already exists
└── basex/
    └── bin/                        # Generated by download-basex.sh
```

### Installation Modes

#### Docker Mode (Recommended)

All services run in containers:
- PostgreSQL (port 5432)
- Redis (port 6379)
- BaseX (ports 1984, 8984)
- Flask application (port 5000)

**Pros:**
- Consistent across environments
- Easy cleanup and restart
- Isolated from host system
- Reproducible deployments

**Cons:**
- More resources used
- Slightly slower on some operations
- Container management overhead

#### Hybrid Mode

Services split:
- PostgreSQL & Redis via Docker
- BaseX runs locally (for debugging, profiling)

**Use when:**
- Developing BaseX itself
- Need to attach debugger to BaseX
- Profiling BaseX performance
- Custom BaseX configuration

---

## Scripts

### setup.sh

**Purpose:** Main orchestration script for installation

**Usage:**
```bash
./setup.sh              # Interactive mode (Docker mode)
./setup.sh --hybrid     # Interactive mode (hybrid mode)
ANSWER_YES=1 ./setup.sh # Non-interactive (CI/CD)
```

**What it does:**
1. Prerequisite checks (Docker, Python, git)
2. Environment setup (copies `.env.example` → `.env`)
3. Python virtual environment creation and dependency installation
4. Docker services startup (PostgreSQL, Redis, BaseX)
5. Database initialization
6. BaseX download (hybrid mode)
7. Health verification

**Exit codes:**
- `0` - Success
- `1` - Prerequisite missing
- `2` - Configuration error
- `3` - Service startup failed

**Key features:**
- Idempotent - safe to run multiple times
- Interactive or automated via env var
- Color-coded output
- Progress indicators

### init-postgres.sh

**Purpose:** Initialize PostgreSQL database structure

**Usage:**
```bash
./scripts/init-postgres.sh           # Structural setup only
./scripts/init-postgres.sh --seed    # + minimal test data
```

**What it does:**
1. Applies `sql/init.sql` schema
2. Creates `dict_user` role
3. Creates `dictionary_analytics` database
4. Creates `dictionary_test` database
5. Sets up extensions (uuid-ossp, pg_trgm, pg_stat_statements)
6. Creates schemas (dictionary, analytics, corpus)
7. (Optional) Imports minimal test data (1-2 entries)

**Key features:**
- Docker-aware (detects container vs local)
- Idempotent (uses `IF NOT EXISTS`)
- Safe for re-runs

### download-basex.sh

**Purpose:** Download and install BaseX locally (hybrid mode)

**Usage:**
```bash
./scripts/download-basex.sh
BASEX_VERSION=11.0 ./scripts/download-basex.sh  # Specific version
```

**What it does:**
1. Detects system architecture
2. Downloads `BaseX-latest.zip` from `https://files.basex.org/releases/`
3. Verifies checksum
4. Extracts to `basex/` directory
5. Makes binaries executable
6. Creates wrapper scripts

**Output structure:**
```
basex/
├── bin/
│   ├── basex
│   ├── basexserver
│   ├── basexclient
│   ├── basexhttp
│   └── ...
└── lib/
```

### verify-setup.sh

**Purpose:** Health check all services

**Usage:**
```bash
./scripts/verify-setup.sh           # Full check with output
./scripts/verify-setup.sh --quiet   # Exit code only
./scripts/verify-setup.sh --docker  # Check Docker containers
```

**Service checks:**

| Service | Check | Port |
|---------|-------|------|
| PostgreSQL | `pg_isready` | 5432 |
| PostgreSQL (test) | `pg_isready` | 5432 |
| BaseX Server | TCP connection | 1984 |
| BaseX HTTP | HTTP request | 8984 |
| Redis | `redis-cli ping` | 6379 |
| Flask App | HTTP request to `/health` | 5000 |

**Output example:**
```
=== Service Health Check ===

PostgreSQL (dictionary_analytics):  ✓ Running (port 5432)
PostgreSQL (dictionary_test):       ✓ Running (port 5432)
BaseX Server:                       ✓ Running (port 1984)
BaseX HTTP:                         ○ Not running (optional)
Redis:                              ✓ Running (port 6379)
Flask App:                          ? Not started (run python run.py)

=== Summary ===
6 services checked, 5 running, 1 not started
```

**Exit codes:**
- `0` - All critical services running
- `1` - One or more critical services down
- `2` - Verification failed

---

## Documentation

### INSTALL.md

**Purpose:** Quick start guide for new administrators

**Sections:**
1. Quick Start (5 commands to running app)
2. Prerequisites (Docker, Python, git, RAM)
3. Installation Modes (Docker vs Hybrid)
4. Troubleshooting (common issues)
5. Environment Variables reference
6. More Information (links to full guide)

**Key principle:** Keep it short - a new admin should be running the app in <5 minutes

### docs/setup-guide.md

**Purpose:** Comprehensive setup documentation

**Sections:**
1. Prerequisites (detailed verification)
2. Installation Modes (comparison)
3. Docker Mode Setup (step-by-step)
4. Hybrid Mode Setup (step-by-step)
5. Configuration (all env vars explained)
6. Initial Data (database structure, seeding)
7. Running the Application (dev vs prod)
8. Testing the Setup (verification commands)
9. Production Considerations (security, performance, backup)
10. Maintenance (updates, migrations, logs)
11. Troubleshooting (common issues with solutions)

---

## Configuration

### Environment Variables

All configuration managed via `.env` file. Template in `.env.example`:

| Variable | Default | Description |
|----------|---------|-------------|
| `POSTGRES_HOST` | `localhost` | PostgreSQL server |
| `POSTGRES_PORT` | `5432` | PostgreSQL port |
| `POSTGRES_DB` | `dictionary_analytics` | Database name |
| `POSTGRES_USER` | `dict_user` | Database user |
| `POSTGRES_PASSWORD` | `dict_pass` | Database password |
| `POSTGRES_POOL_SIZE` | `10` | Connection pool size |
| `POSTGRES_MAX_OVERFLOW` | `20` | Pool overflow |
| `BASEX_HOST` | `localhost` | BaseX server |
| `BASEX_PORT` | `1984` | BaseX port |
| `BASEX_USERNAME` | `admin` | BaseX user |
| `BASEX_PASSWORD` | `admin` | BaseX password |
| `BASEX_DATABASE` | `dictionary` | BaseX database |
| `REDIS_HOST` | `localhost` | Redis server |
| `REDIS_PORT` | `6379` | Redis port |
| `FLASK_ENV` | `development` | `development` or `production` |
| `SECRET_KEY` | (generated) | Flask secret key |

### Docker Compose Integration

The setup scripts integrate with existing `docker-compose.yml`:

```bash
# Start specific services only
docker-compose up -d postgres redis

# Start all services
docker-compose up -d

# View logs
docker-compose logs -f
```

---

## Implementation Tasks

### Phase 1: Documentation

- [ ] Create `INSTALL.md` (quick start guide)
- [ ] Create `docs/setup-guide.md` (comprehensive guide)

### Phase 2: Scripts

- [ ] Create `scripts/download-basex.sh`
- [ ] Create `scripts/init-postgres.sh`
- [ ] Create `scripts/verify-setup.sh`
- [ ] Create `scripts/setup.sh`

### Phase 3: Testing

- [ ] Test Docker mode installation from scratch
- [ ] Test hybrid mode installation from scratch
- [ ] Test verification script
- [ ] Test non-interactive mode (ANSWER_YES=1)

### Phase 4: Cleanup

- [ ] Remove duplicate/outdated documentation
- [ ] Update `docs/POSTGRESQL_WSL_SETUP.md` to reference new guide
- [ ] Update `docs/CLAUDE.md` to reference new install scripts

---

## Migration from Existing Setup

For users with existing installations:

1. Backup current data
2. Pull latest code
3. Run `./setup.sh` (idempotent - won't break existing config)
4. Verify with `./scripts/verify-setup.sh`

Existing `.env` files are preserved - no action required.

---

## Security Considerations

1. **Default passwords** - Document that `.env.example` contains defaults that must be changed for production
2. **Secret key** - Generate random key if not present
3. **Docker secrets** - Consider for production deployments
4. **Network isolation** - Docker Compose uses bridge network

---

## Future Enhancements

- [ ] `scripts/backup.sh` - Automated backup script
- [ ] `scripts/update.sh` - One-command update script
- [ ] Helm chart for Kubernetes deployment
- [ ] Ansible/Terraform provisioning scripts
- [ ] Monitoring dashboard setup

---

## References

- Existing `.env.example` - Environment variable template
- Existing `docker-compose.yml` - Docker services configuration
- Existing `sql/init.sql` - PostgreSQL schema
- Existing `docs/POSTGRESQL_WSL_SETUP.md` - WSL-specific PostgreSQL guide
- Existing `setup-wsl.sh` - Existing WSL setup script
- Existing `start-services.sh` - Existing service startup script
- BaseX releases: https://files.basex.org/releases/
