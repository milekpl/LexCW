{% extends "base.html" %}

{% block title %}{% if entry.id %}Edit Entry: {% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}{% else %}Add New Entry{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/form-tooltips.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/validation-feedback.css') }}">
{% endblock %}



{% block content %}
{% if validation_result and not validation_result.is_valid %}
<!-- Validation Guidance Section -->
<div class="alert alert-warning mb-4" role="alert">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Entry Validation Guidance</h5>
    <p class="mb-3">This entry has validation issues that should be addressed. You can still edit and save the entry, but fixing these issues will improve data quality.</p>
    
    {% if validation_result.errors %}
    <div class="validation-errors mb-3">
        <h6><i class="fas fa-times-circle text-danger"></i> Critical Issues:</h6>
        <ul class="mb-0">
        {% for error in validation_result.errors %}
            <li class="text-danger">{{ error.message }} <small class="text-muted">({{ error.rule_id }})</small></li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if validation_result.warnings %}
    <div class="validation-warnings">
        <h6><i class="fas fa-exclamation-circle text-warning"></i> Warnings:</h6>
        <ul class="mb-0">
        {% for warning in validation_result.warnings %}
            <li class="text-warning">{{ warning.message }} <small class="text-muted">({{ warning.rule_id }})</small></li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            {% if entry.id %}
            <i class="fas fa-edit"></i> Edit Entry: <span class="text-primary">{% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}</span>
            {% else %}
            <i class="fas fa-plus"></i> Add New Entry
            {% endif %}
        </h2>
    </div>
    <div class="col-md-4 text-end">
        <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#fieldVisibilityModal">
            <i class="fas fa-cog"></i> Field Settings
        </button>
        {% if entry.id %}
        <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-eye"></i> View Entry
        </a>
        {% endif %}
        <a href="{{ url_for('main.entries') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list"></i> All Entries
        </a>
    </div>
</div>

{% set source_lang = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS and current_app.config.PROJECT_SETTINGS.source_language else 'en' %}
<form id="entry-form" method="post" data-source-language="{{ source_lang }}" novalidate>
    {% if entry.id %}
        <input type="hidden" name="id" value="{{ entry.id }}">
    {% endif %}
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 basic-info-section">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-book"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="lexical-unit" class="form-label">Lexical Unit <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lexical-unit" name="lexical_unit" 
                               value="{% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}" required>
                        <div class="form-text">The headword as it appears in the dictionary.</div>
                    </div>

                    <!-- Homograph Number Display - Only show if entry has a homograph number -->
                    {% if entry.homograph_number %}
                    <div class="mb-3">
                        <label for="homograph-number" class="form-label">
                            Homograph Number
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="This entry is assigned homograph number {{ entry.homograph_number }} to distinguish it from other entries with the same lexical unit."></i>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="homograph-number" name="homograph_number" 
                               value="{{ entry.homograph_number }}" readonly>
                        <div class="form-text">Automatically assigned to distinguish homographs (entries sharing the same headword).</div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="citation-form" class="form-label">Citation Form</label>
                        <input type="text" class="form-control" id="citation-form" name="citation_form" 
                               value="{{ entry.citation_form }}">
                        <div class="form-text">Optional citation form if different from the headword.</div>
                    </div>

                    <div class="mb-3">
                        <label for="part-of-speech" class="form-label">
                            Part of Speech <span class="text-muted" id="pos-required-indicator" style="display: none;">*</span>
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                                   title="This field is automatically inherited from senses. If all senses have the same grammatical category, it will be set automatically. If there are discrepancies, you'll need to resolve them manually."></i>
                            </span>
                        </label>
                        <select class="form-select dynamic-grammatical-info" id="part-of-speech" name="grammatical_info.part_of_speech"
                                data-selected="{% if entry.grammatical_info %}{{ entry.grammatical_info }}{% endif %}"
                                data-range-id="grammatical-info">
                            <option value="">Select part of speech</option>
                            <!-- Options will be dynamically loaded from LIFT ranges -->
                        </select>
                    </div>

                    <!-- LIFT Ranges: Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select dynamic-lift-range" id="status" name="status" 
                                data-range-id="status"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select status</option>
                        </select>
                    </div>

                    <!-- LIFT Ranges: Morphological Type -->
                    <div class="mb-3">
                        <label for="morph-type" class="form-label">
                            Morphological Type
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                                   title="Automatically classified based on headword form: contains whitespace=phrase, ends with hyphen=prefix, starts with hyphen=suffix, both=infix, default=stem."></i>
                            </span>
                        </label>
                        <select class="form-select dynamic-lift-range" id="morph-type" name="morph_type" 
                                data-range-id="morph-type"
                                data-selected="{% if entry.morph_type %}{{ entry.morph_type }}{% endif %}"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select morphological type</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Custom Fields Section -->
            {% if entry.custom_fields %}
            <div class="card mb-4 custom-fields-section">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-cogs"></i> Custom Fields 
                        <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                            <i class="fas fa-info-circle text-white" data-bs-toggle="tooltip" data-bs-placement="top" 
                               title="Custom fields defined in the LIFT data. These fields contain additional metadata and domain-specific information not covered by standard LIFT elements."></i>
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for field_type, field_content in entry.custom_fields.items() %}
                    <div class="custom-field-item mb-4 border rounded p-3 bg-light" data-field-type="{{ field_type }}">
                        <div class="row align-items-center mb-2">
                            <div class="col-md-8">
                                <label class="form-label fw-bold text-capitalize">{{ field_type|replace('_', ' ')|title }}</label>
                                <small class="text-muted d-block">Field Type: {{ field_type }}</small>
                            </div>
                        </div>
                        
                        {% if field_content is mapping %}
                            <!-- Multilingual custom field -->
                            <div class="multilingual-forms">
                                {% for lang, text in field_content.items() %}
                                <div class="mb-3 language-form" data-language="{{ lang }}">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Language</label>
                                            <input type="text" class="form-control bg-white" value="{{ lang }}" readonly>
                                        </div>
                                        <div class="col-md-9">
                                            <label class="form-label">Content</label>
                                            <textarea class="form-control" 
                                                      name="custom_fields[{{ field_type }}][{{ lang }}]" 
                                                      rows="2">{{ text }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Simple custom field -->
                            <div class="mb-3">
                                <label class="form-label">Content</label>
                                <textarea class="form-control" 
                                          name="custom_fields[{{ field_type }}]" 
                                          rows="2">{{ field_content }}</textarea>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Multilingual Notes Section -->
            <div class="card mb-4 notes-section">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-sticky-note"></i> Entry Notes</h5>
                </div>
                <div class="card-body">
                    <div id="notes-container">
                        <!-- Server-side rendered note items -->
                        {% if entry.notes %}
                            {% for note_type, note_content in entry.notes.items() %}
                            <div class="note-item mb-4 border rounded p-3" data-note-type="{{ note_type }}">
                                <div class="row align-items-center mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Note Type</label>
                                        <select class="form-select note-type-select" name="notes.{{ note_type }}.type">
                                            <option value="general" {% if note_type == 'general' %}selected{% endif %}>General</option>
                                            <option value="usage" {% if note_type == 'usage' %}selected{% endif %}>Usage</option>
                                            <option value="semantic" {% if note_type == 'semantic' %}selected{% endif %}>Semantic</option>
                                            <option value="etymology" {% if note_type == 'etymology' %}selected{% endif %}>Etymology</option>
                                            <option value="cultural" {% if note_type == 'cultural' %}selected{% endif %}>Cultural</option>
                                            <option value="anthropology" {% if note_type == 'anthropology' %}selected{% endif %}>Anthropology</option>
                                            <option value="discourse" {% if note_type == 'discourse' %}selected{% endif %}>Discourse</option>
                                            <option value="phonology" {% if note_type == 'phonology' %}selected{% endif %}>Phonology</option>
                                            <option value="sociolinguistics" {% if note_type == 'sociolinguistics' %}selected{% endif %}>Sociolinguistics</option>
                                            <option value="bibliography" {% if note_type == 'bibliography' %}selected{% endif %}>Bibliography</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-note-btn" 
                                                title="Remove note">
                                            <i class="fas fa-trash"></i> Remove Note
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="multilingual-forms">
                                    {% if note_content is mapping %}
                                        <!-- Multilingual note -->
                                        {% for lang, text in note_content.items() %}
                                        <div class="mb-3 language-form" data-language="{{ lang }}">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-select" name="notes.{{ note_type }}.{{ lang }}.lang">
                                                        {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                        {% if lang not in project_lang_codes %}
                                                            <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                        {% endif %}
                                                        {% for code, label in project_languages %}
                                                            <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-8">
                                                    <label class="form-label">Note Text</label>
                                                    <textarea class="form-control note-text" 
                                                              name="notes.{{ note_type }}.{{ lang }}.text" 
                                                              rows="2" 
                                                              placeholder="Enter note text in {{ lang }}">{{ text }}</textarea>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-language-btn" 
                                                            title="Remove language">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Legacy single text note -->
                                        {# Default to source language if note is a simple string #}
                                        {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                        <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-select" name="notes.{{ note_type }}.{{ default_lang_code }}.lang">
                                                        {% for code, label in project_languages %}
                                                            <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    
                                                    {% if default_lang_code not in configured_languages_codes %}
                                                    <div class="validation-warnings mt-1">
                                                        <small class="text-warning">
                                                            <i class="fas fa-exclamation-triangle"></i> 
                                                            Warning: Language '{{ default_lang_code }}' is not configured for this project.
                                                        </small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-8">
                                                    <label class="form-label">Note Text</label>
                                                    <textarea class="form-control note-text" 
                                                              name="notes.{{ note_type }}.{{ default_lang_code }}.text"
                                                              rows="2" 
                                                              placeholder="Enter note text in {{ default_lang_code }}">{{ note_content }}</textarea>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-language-btn" 
                                                            title="Remove language">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary add-language-btn" 
                                            title="Add another language">
                                        <i class="fas fa-plus"></i> Add Language
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no notes exist -->
                        {% if not entry.notes %}
                        <div class="text-muted mb-3" id="no-notes-message">
                            No notes added yet. Click "Add Note" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
            </div>
            
            <div class="card mb-4 pronunciation-section">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-microphone"></i> Pronunciation</h5>
                </div>
                <div class="card-body">
                    <div id="pronunciation-container">
                        <!-- Server-side rendered pronunciation items -->
                        {% if entry.pronunciations %}
                            {% for ws, pronunciation in entry.pronunciations.items() %}
                            <div class="pronunciation-item mb-3 border-bottom pb-3" data-index="{{ loop.index0 }}">
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label">IPA</label>
                                        <input type="text" class="form-control ipa-input" 
                                               name="pronunciations[{{ loop.index0 }}].value" 
                                               value="{{ pronunciation }}" 
                                               placeholder="IPA transcription">
                                        <input type="hidden" name="pronunciations[{{ loop.index0 }}].type" value="{{ ws }}">
                                        <div class="form-text">International Phonetic Alphabet (IPA)</div>
                                    </div>
                                </div>
                                
                                <div class="mt-2 mb-2">
                                    <label class="form-label">Audio File</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="pronunciations[{{ loop.index0 }}].audio_path" 
                                               value="{{ pronunciation.audio_path if pronunciation.audio_path else '' }}" readonly 
                                               title="Audio file path" placeholder="No audio file">
                                        <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                                                data-index="{{ loop.index0 }}" title="Upload audio file">
                                            <i class="fas fa-upload"></i> Upload Audio
                                        </button>
                                    </div>
                                    
                                    <!-- Show existing audio preview if audio file exists -->
                                    {% if pronunciation.audio_path %}
                                    <div class="audio-preview mt-2">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Audio file: {{ pronunciation.audio_path }}</small>
                                                <audio controls class="w-100 mt-1" preload="metadata">
                                                    <source src="{{ url_for('static', filename='audio/' + pronunciation.audio_path) }}">
                                                    Your browser does not support the audio element.
                                                </audio>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-audio-btn" 
                                                    title="Remove audio file">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" 
                                           id="pron-default-{{ loop.index0 }}" name="pronunciations[{{ loop.index0 }}].is_default"
                                           {% if loop.index0 == 0 %}checked{% endif %}>
                                    <label class="form-check-label" for="pron-default-{{ loop.index0 }}">
                                        Default pronunciation
                                    </label>
                                </div>
                                
                                {% if loop.index0 > 0 %}
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                                            data-index="{{ loop.index0 }}" title="Remove pronunciation">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no pronunciations exist -->
                        {% if not entry.pronunciations %}
                        <div class="text-muted mb-3" id="no-pronunciations-message">
                            No pronunciations added yet. Click "Add Pronunciation" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-pronunciation-btn">
                        <i class="fas fa-plus"></i> Add Pronunciation
                    </button>
                </div>
            </div>
            
            <div class="card mb-4 variants-section">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-code-branch"></i> Variants
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Variants:</strong><br>Variants represent different forms, spellings, or morphological variations of the same lexical item. Examples include 'protestor' vs 'protester', 'Protestant ethic' vs 'Protestant work ethic', or inflected forms like plurals and past tense forms."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-variant-btn">
                            <i class="fas fa-plus"></i> Add Variant
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="variants-container">
                        <!-- Server-side rendered variant items -->
                        {% if variant_relations %}
                            {% for variant in variant_relations %}
                            <div class="variant-item card mb-3" data-variant-index="{{ loop.index0 }}" data-direction="{{ variant.direction or 'outgoing' }}">
                                <div class="card-header {% if variant.direction == 'incoming' %}bg-info{% else %}bg-success{% endif %} text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas {% if variant.direction == 'incoming' %}fa-arrow-left{% else %}fa-arrow-right{% endif %} me-2"></i>
                                            {% if variant.direction == 'incoming' %}
                                                Has Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% else %}
                                                Is a Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% endif %}
                                        </h6>
                                        {% if variant.direction != 'incoming' %}
                                        <button type="button" class="btn btn-sm btn-light remove-variant-btn" 
                                                data-index="{{ loop.index0 }}" title="Remove variant">
                                            <i class="fas fa-trash text-danger"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    {% if variant.direction == 'incoming' %}
                                    <!-- Incoming: Other entries ARE variants of this entry (display only) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Entry that is a variant of this one</label>
                                            {% if variant.ref_display_text %}
                                            <div class="alert alert-light">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit this entry">
                                                        {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                    </a>
                                                </strong>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Entry Not Found: </strong>
                                                The entry ID "<code>{{ variant.ref }}</code>" could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect reference.</small>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-question-circle me-2"></i>
                                                <strong>No Entry Referenced</strong>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">
                                                Variant Type                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>Reverse Relationship:</strong><br>{% if variant.ref_display_text %}The entry '<strong>{{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}</strong>' is marked as a {{ variant.variant_type }} of this entry.{% elif variant.ref %}An entry with ID '{{ variant.ref }}' is marked as a {{ variant.variant_type }} of this entry, but the entry could not be found.{% else %}An unknown entry is marked as a {{ variant.variant_type }} of this entry.{% endif %} This relationship is defined in the other entry's data."></i>
                                            </label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-info fs-6">{{ variant.variant_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <!-- Outgoing: This entry IS a variant of another (editable) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Target Entry</label>
                                            {% if variant.ref_display_text %}
                                            <!-- Show clickable link to target entry -->
                                            <div class="alert alert-light mb-2">
                                                <i class="fas fa-external-link-alt me-2"></i>
                                                <strong>This entry is a variant of: </strong>
                                                <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                   class="text-decoration-none text-primary fw-bold"
                                                   title="Edit target entry">
                                                    {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                </a>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger mb-2">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Target Entry Not Found: </strong>
                                                The referenced entry could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect reference.</small>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}][ref]"
                                                   value="{{ variant.ref or '' }}">
                                            <!-- Hidden technical fields -->
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}][type]"
                                                   value="{{ variant.type or '_component-lexeme' }}">
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}][order]"
                                                   value="{{ variant.order or loop.index0 }}">
                                            
                                            <!-- Search interface for adding/changing variant targets -->
                                            <div class="input-group">
                                                <input type="text" class="form-control variant-search-input" 
                                                       placeholder="Search for entry to create variant relationship with..."
                                                       data-variant-index="{{ loop.index0 }}">
                                                <button type="button" class="btn btn-outline-secondary variant-search-btn" 
                                                        data-variant-index="{{ loop.index0 }}">
                                                    <i class="fas fa-search"></i> Search
                                                </button>
                                            </div>
                                            <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                            <div class="search-results mt-2" id="variant-search-results-{{ loop.index0 }}" style="display: none;"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Variant Type</label>
                                            <select class="form-control" 
                                                    name="variant_relations[{{ loop.index0 }}][variant_type]" required>
                                                <option value="">Select variant type</option>
                                                <option value="Spelling Variant" {% if variant.variant_type == 'Spelling Variant' %}selected{% endif %}>Spelling Variant</option>
                                                <option value="Dialectal Variant" {% if variant.variant_type == 'Dialectal Variant' %}selected{% endif %}>Dialectal Variant</option>
                                                <option value="Unspecified Variant" {% if variant.variant_type == 'Unspecified Variant' %}selected{% endif %}>Unspecified Variant</option>
                                                <option value="Stopień najwyższy" {% if variant.variant_type == 'Stopień najwyższy' %}selected{% endif %}>Stopień najwyższy</option>
                                                <option value="Plural Form" {% if variant.variant_type == 'Plural Form' %}selected{% endif %}>Plural Form</option>
                                                <option value="Past Tense" {% if variant.variant_type == 'Past Tense' %}selected{% endif %}>Past Tense</option>
                                            </select>
                                            <div class="form-text">Type of variant relationship</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">
                                                Status
                                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                                   data-bs-toggle="tooltip" 
                                                   data-bs-placement="top"
                                                   data-bs-html="true"
                                                   title="<strong>Variant Relationship:</strong><br>This entry is a variant of {% if variant.ref_display_text %}'<strong>{{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}</strong>'.{% elif variant.ref %}a target entry that could not be found.{% else %}an unspecified entry.{% endif %}"></i>
                                            </label>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-check-circle me-1"></i>Active Variant
                                                </span>
                                                <div class="form-text">This variant will be saved to the dictionary</div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Empty state when no variants exist -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-code-branch fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Variant Relations</h5>
                            <p class="text-muted">This entry does not have any variant relations defined.</p>
                            <p class="text-muted">
                                <strong>What are variants?</strong> Variants are different forms or spellings of the same lexical item, 
                                such as "protestor" vs "protester", or "Protestant ethic" vs "Protestant work ethic".
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Component Relations Section -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group"></i> Complex Form Components
                        <i class="fas fa-info-circle ms-2 form-tooltip" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           data-bs-html="true"
                           title="<strong>About Complex Forms:</strong><br>Complex forms are entries like compounds ('basketball'), phrases ('Protestant work ethic'), or other multi-word expressions that function as single lexical units. They are composed of multiple lexical components."></i>
                    </h5>
                </div>
                <div class="card-body">
                    {% if component_relations and component_relations|length > 0 %}
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>This entry is a complex form</strong> composed of the following main entries:
                        </div>
                        
                        {% for component in component_relations %}
                        <div class="component-item card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-puzzle-piece me-2"></i>
                                    Component {{ loop.index }} ({{ component.complex_form_type }})
                                    {% if component.is_primary %}
                                    <span class="badge bg-success ms-2">Primary</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if component.ref_display_text %}
                                <!-- Show clickable link to main entry -->
                                <div class="alert alert-primary mb-0">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    <strong>Main Entry: </strong>
                                    <a href="{{ url_for('main.edit_entry', entry_id=component.ref) }}" 
                                       class="text-decoration-none text-primary fw-bold"
                                       title="Edit main entry">
                                        {{ component.ref_display_text|safe }}
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        <strong>Type:</strong> {{ component.complex_form_type }} 
                                        | <strong>Order:</strong> {{ component.order if component.order is not none else 'N/A' }}
                                    </small>
                                </div>
                                {% elif component.ref %}
                                <!-- Show error marker for missing main entry -->
                                <div class="alert alert-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Main Entry Not Found: </strong>
                                    The referenced main entry ID "<code>{{ component.ref }}</code>" could not be found in the dictionary.
                                    <br><small>This may indicate a missing entry or an incorrect ID.</small>
                                </div>
                                {% else %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-question-circle me-2"></i>
                                    <strong>No Main Entry Referenced</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                    {% else %}
                        <!-- Empty state when no component relations exist -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-puzzle-piece fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Complex Form Components</h5>                            
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-4 relations-section">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-link"></i> Relations
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Relations:</strong><br>Relations represent semantic connections between different lexical entries. Examples include synonyms (words with similar meanings), antonyms (opposite meanings), hyponyms (specific instances of a general term), and hypernyms (general terms for specific instances). These are distinct from variants that represent different forms of the same lexical item."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-relation-btn">
                            <i class="fas fa-plus"></i> Add Relation
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="relations-container">
                        <!-- Server-side rendered relation items -->
                        {% if entry.relations %}
                            {% set filtered_relations = [] %}
                            {% for relation in entry.relations %}
                                {# Filter out _component-lexeme relations with variant-type or complex-form-type traits #}
                                {% if not (relation.type == '_component-lexeme' and relation.traits and ('variant-type' in relation.traits or 'complex-form-type' in relation.traits)) %}
                                    {% set _ = filtered_relations.append(relation) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if filtered_relations %}
                                {% for relation in filtered_relations %}
                                <div class="relation-item card mb-3" data-relation-index="{{ loop.index0 }}">
                                    <div class="card-header bg-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-link me-2"></i>
                                                Relation: {{ relation.type or 'Unknown Type' }}
                                            </h6>
                                            <button type="button" class="btn btn-sm btn-light remove-relation-btn" 
                                                    data-index="{{ loop.index0 }}" title="Remove relation">
                                                <i class="fas fa-trash text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold">
                                                    Relation Type
                                                    <i class="fas fa-info-circle ms-1 form-tooltip" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top"
                                                       data-bs-html="true"
                                                       title="<strong>Semantic Relationship:</strong><br>This entry has a '{{ relation.type }}' relationship with {% if relation.ref_display_text %}'<strong>{{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}</strong>'.{% else %}the target entry.{% endif %}"></i>
                                                </label>
                                                <select class="form-control relation-type-select" 
                                                        name="relations[{{ loop.index0 }}][type]" 
                                                        data-range-id="lexical-relation"
                                                        data-hierarchical="true"
                                                        data-searchable="true"
                                                        required>
                                                    <option value="">Select type</option>
                                                    <!-- Options will be populated dynamically from LIFT ranges -->
                                                </select>
                                                <div class="form-text">Type of semantic relation</div>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label fw-bold">Target Entry</label>
                                                {% if relation.ref_display_text %}
                                                <!-- Show clickable link to target entry -->
                                                <div class="alert alert-light mb-2">
                                                    <i class="fas fa-external-link-alt me-2"></i>
                                                    <strong>Related to: </strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=relation.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit target entry">
                                                        {{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}
                                                    </a>
                                                </div>
                                                {% endif %}
                                                
                                                <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                                <input type="hidden" 
                                                       name="relations[{{ loop.index0 }}][ref]"
                                                       value="{{ relation.ref or '' }}">
                                                
                                                <!-- Search interface for adding/changing relations -->
                                                <div class="input-group">
                                                    <input type="text" class="form-control relation-search-input" 
                                                           placeholder="Search for entry to relate to..."
                                                           data-relation-index="{{ loop.index0 }}">
                                                    <button type="button" class="btn btn-outline-secondary relation-search-btn" 
                                                            data-relation-index="{{ loop.index0 }}">
                                                        <i class="fas fa-search"></i> Search
                                                    </button>
                                                </div>
                                                <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                                <div class="search-results mt-2" id="search-results-{{ loop.index0 }}" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <!-- Empty state when no non-variant relations exist -->
                            <div class="empty-state text-center py-4">
                                <i class="fas fa-link fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Semantic Relations</h5>
                            </div>
                            {% endif %}
                        {% else %}
                        <!-- Empty state when no relations exist at all -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-link fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Semantic Relations</h5>
                        </div>
                        {% endif %}
                    </div>
                    
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Etymology
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Etymology:</strong><br>Etymology traces the historical origin and development of words. This includes information about source languages, etymological forms, meanings, and the type of linguistic change (inheritance, borrowing, derivation, etc.)."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-etymology-btn">
                            <i class="fas fa-plus"></i> Add Etymology
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="etymology-container">
                        <!-- Etymology forms will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card senses-section">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Senses</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-sense-btn">
                            <i class="fas fa-plus"></i> Add Sense
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <div id="senses-container">
                        {% if entry.senses %}
                            {% for sense in entry.senses %}
                                <div class="sense-item card mb-4" data-sense-index="{{ loop.index0 }}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="drag-handle me-2" title="Drag to reorder" style="cursor: grab;">
                                        <i class="fas fa-grip-vertical text-muted"></i>
                                    </div>
                                    <span>Sense {{ loop.index }}</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary move-sense-up" title="Move Up">↑</button>
                                    <button type="button" class="btn btn-sm btn-secondary move-sense-down" title="Move Down">↓</button>                                                                            
                                    {% if entry.senses|length > 1 %}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                                                data-index="{{ loop.index0 }}">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    {% endif %}
                                </div>
                                </div>
                                    <div class="card-body">
                                        <!-- Hidden field for sense ID -->
                                        <input type="hidden" name="senses[{{ loop.index0 }}].id" value="{{ sense.id }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Definition <span class="text-danger">*</span></label>
                                            <div class="multilingual-forms definition-forms">
                                                {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                {% if sense.definitions is mapping %}
                                                {% set data_langs = sense.definitions.keys()|list %}
                                                {% set all_langs = (project_lang_codes + data_langs)|unique %}
                                                {% for lang in all_langs %}
                                                    {% set text = sense.definitions[lang]['text'] if lang in sense.definitions and 'text' in sense.definitions[lang] else '' %}
                                                    <div class="mb-3 language-form" data-language="{{ lang }}">
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <label class="form-label">Language</label>
                                                                <select class="form-select language-select"
                                                                        data-field-name="senses[{{ loop.index0 }}].definition.{{ lang }}">
                                                                {# Language select without name attribute - language code is already in the field path #}
                                                                    {% if lang not in project_lang_codes %}
                                                                        <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                                    {% endif %}
                                                                    {% for code, label in project_languages %}
                                                                        <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-9">
                                                                <label class="form-label">Definition Text</label>
                                                                <textarea class="form-control definition-text" 
                                                                          name="senses[{{ loop.index0 }}].definition.{{ lang }}.text" 
                                                                          rows="2" 
                                                                          {% if loop.first %}required{% endif %}
                                                                          placeholder="Enter definition in {{ lang }}">{{ text }}</textarea>
                                                            </div>
                                                            <div class="col-md-1 d-flex align-items-end">
                                                                {% if not loop.first %}
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-definition-language-btn" 
                                                                        title="Remove language">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                {% else %}
                                                    {# Default to source language if definition is a simple string #}
                                                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <label class="form-label">Language</label>
                                                                <select class="form-select language-select" 
                                                                        data-field-name="senses[{{ loop.index0 }}].definition.{{ default_lang_code }}">
                                                                {# Language select without name attribute - language code is already in the field path #}
                                                                    {% if default_lang_code not in project_lang_codes %}
                                                                        <option value="{{ default_lang_code }}" selected>{{ default_lang_code }} (original)</option>
                                                                    {% endif %}
                                                                    {% for code, label in project_languages %}
                                                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <label class="form-label">Definition Text</label>
                                                                <textarea class="form-control definition-text" 
                                                                          name="senses[{{ loop.index0 }}].definition.{{ default_lang_code }}.text"
                                                                          rows="2" 
                                                                          required
                                                                          placeholder="Enter definition in {{ default_lang_code }}">{{ sense.definition }}</textarea>
                                                            </div>
                                                            <div class="col-md-1">
                                                                <!-- No remove button for primary language -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add another language">
                                                    <i class="fas fa-plus"></i> Add Language
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Gloss</label>
                                            <div class="multilingual-forms gloss-forms">
                                                {% if sense.gloss is mapping %}
                                                {% for lang, gloss_val in sense.gloss.items() %}
                                                {% set text = gloss_val['text'] if gloss_val is mapping and 'text' in gloss_val else gloss_val %}
                                                <div class="mb-3 language-form" data-language="{{ lang }}">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Language</label>
                                                            <select class="form-select language-select"
                                                                    data-field-name="senses[{{ loop.index0 }}].gloss.{{ lang }}">
                                                                {# Language select without name attribute #}
                                                                {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                                {% if lang not in project_lang_codes %}
                                                                    <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                                {% endif %}
                                                                {% for code, label in project_languages %}
                                                                    <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <label class="form-label">Gloss Text</label>
                                                            <input type="text" class="form-control gloss-text" 
                                                                   name="senses[{{ loop.index0 }}].gloss.{{ lang }}.text" 
                                                                   value="{{ text }}"
                                                                   placeholder="Enter gloss in {{ lang }}">
                                                        </div>
                                                        <div class="col-md-1 d-flex align-items-end">
                                                            {% if not loop.first %}
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-gloss-language-btn" 
                                                                    title="Remove language">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                    {% endfor %}
                                                {% else %}
                                                    {# Default to target language if gloss is a simple string #}
                                                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <label class="form-label">Language</label>
                                                                <select class="form-select language-select" 
                                                                        data-field-name="senses[{{ loop.index0 }}].gloss.{{ default_lang_code }}">
                                                                {# Language select without name attribute #}
                                                                    {% for code, label in project_languages %}
                                                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <label class="form-label">Gloss Text</label>
                                                                <input type="text" class="form-control gloss-text" 
                                                                       name="senses[{{ loop.index0 }}].gloss.{{ default_lang_code }}.text"
                                                                       value="{{ sense.gloss }}"
                                                                       placeholder="Enter gloss in {{ default_lang_code }}">
                                                            </div>
                                                            <div class="col-md-1">
                                                                <!-- No remove button for primary language -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add another language">
                                                    <i class="fas fa-plus"></i> Add Language
                                                </button>
                                            </div>
                                            <div class="form-text">A short equivalent in another language.</div>
                                        </div>
                                        
                        <div class="mb-3">
                            <label for="part-of-speech" class="form-label">Part of Speech</label>
                            <select class="form-select dynamic-grammatical-info" name="senses[{{ loop.index0 }}].grammatical_info"
                                    data-selected="{{ sense.grammatical_info }}"
                                    data-range-id="grammatical-info">
                                <option value="">Select part of speech</option>
                            </select>
                            <div class="form-text">Grammatical category for this sense.</div>
                        </div>
                        
                        <!-- LIFT Ranges: Semantic Domain (sense-level) -->
                        <div class="mb-3">
                            <label class="form-label">Semantic Domain</label>
                            <select class="form-select dynamic-lift-range" 
                                    name="senses[{{ loop.index0 }}].domain_type" 
                                    data-range-id="semantic-domain-ddp4" 
                                    data-hierarchical="true" 
                                    data-searchable="true"
                                    data-selected="{{ sense.domain_type|join(';') if sense.domain_type else '' }}"
                                    multiple>
                                <option value="">Select semantic domain(s)</option>
                            </select>
                            <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
                        </div>
                        
                        <!-- LIFT Ranges: Usage Type (sense-level) -->
                        <div class="mb-3">
                            <label class="form-label">Usage Type</label>
                            <select class="form-select dynamic-lift-range" 
                                    name="senses[{{ loop.index0 }}].usage_type" 
                                    data-range-id="usage-type"
                                    data-hierarchical="true"
                                    data-searchable="true"
                                    data-selected="{{ sense.usage_type|join(';') if sense.usage_type else '' }}"
                                    multiple>
                                <option value="">Select usage type(s)</option>
                            </select>
                            <div class="form-text">Usage classification for this sense (can select multiple).</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sense Note</label>
                            <textarea class="form-control" name="senses[{{ loop.index0 }}].note" 
                                      rows="2">{{ sense.note }}</textarea>
                        </div>                                        <div class="examples-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="{{ loop.index0 }}">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                            
                                            <div class="examples-container">
                                                {% if sense.examples %}
                                                {% for example in sense.examples %}
                                                    <div class="example-item card mb-3" data-example-index="{{ loop.index0 }}">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <h6 class="mb-0">Example {{ loop.index }}</h6>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn"
                                                                        data-sense-index="0" data-example-index="{{ loop.index0 }}">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Example Sentence</label>
                                                                <textarea class="form-control" name="senses[0].examples[{{ loop.index0 }}].sentence"
                                                                          rows="2">{{ example.sentence }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Translation</label>
                                                                <textarea class="form-control" name="senses[0].examples[{{ loop.index0 }}].translation"
                                                                          rows="2">{{ example.translation }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Translation Type
                                                                    <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                                                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                           title="Specify the type of translation: 'literal' for word-for-word translation, 'free' for natural/idiomatic translation, or other types as defined in your project."></i>
                                                                    </span>
                                                                </label>
                                                                <select class="form-select dynamic-lift-range" 
                                                                        name="senses[0].examples[{{ loop.index0 }}].translation_type"
                                                                        data-range-id="translation-type"
                                                                        data-hierarchical="false"
                                                                        data-searchable="true">
                                                                    <option value="">Select translation type</option>
                                                                    <option value="literal" {% if example.translation_type == 'literal' %}selected{% endif %}>Literal</option>
                                                                    <option value="free" {% if example.translation_type == 'free' %}selected{% endif %}>Free/Idiomatic</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                {% else %}
                                                    <div class="no-examples text-center text-muted py-3 border rounded">
                                                        <p>No examples added yet</p>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                                data-sense-index="{{ loop.index0 }}">
                                                            <i class="fas fa-plus"></i> Add Example
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        {% endfor %}
                        {% else %}
                            <div class="sense-item card mb-4 default-sense-template" data-sense-index="0" id="default-sense-template">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Sense 1</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Definition <span class="text-danger">*</span></label>
                                        <div class="multilingual-forms definition-forms">
                                            {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                            <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Language</label>
                                                        <select class="form-select language-select" 
                                                                data-field-name="senses[0].definition.{{ default_lang_code }}">
                                                        {# Language select without name attribute #}
                                                            {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                            {% if default_lang_code not in project_lang_codes %}
                                                                <option value="{{ default_lang_code }}" selected>{{ default_lang_code }} (original)</option>
                                                            {% endif %}
                                                            {% for code, label in project_languages %}
                                                                <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="form-label">Definition Text</label>
                                                        <textarea class="form-control definition-text" 
                                                                  name="senses[0].definition.{{ default_lang_code }}.text"
                                                                  rows="2" 
                                                                  required
                                                                  placeholder="Enter definition in {{ default_lang_code }}"></textarea>
                                                    </div>
                                                    <div class="col-md-1">
                                                        <!-- No remove button for primary language -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                                                    data-sense-index="0"
                                                    title="Add another language">
                                                <i class="fas fa-plus"></i> Add Language
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Gloss</label>
                                        <div class="multilingual-forms gloss-forms">
                                            {% set default_lang_code = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                            <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Language</label>
                                                        <select class="form-select language-select" 
                                                                data-field-name="senses[0].gloss.{{ default_lang_code }}">
                                                        {# Language select without name attribute #}
                                                            {% for code, label in project_languages %}
                                                                <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="form-label">Gloss Text</label>
                                                        <input type="text" class="form-control gloss-text" 
                                                               name="senses[0].gloss.{{ default_lang_code }}.text"
                                                               value=""
                                                               placeholder="Enter gloss in {{ default_lang_code }}">
                                                    </div>
                                                    <div class="col-md-1">
                                                        <!-- No remove button for primary language -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                                                    data-sense-index="0"
                                                    title="Add another language">
                                                <i class="fas fa-plus"></i> Add Language
                                            </button>
                                        </div>
                                        <div class="form-text">A short equivalent in another language.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Part of Speech</label>
                                        <select class="form-select dynamic-grammatical-info" name="senses[0].grammatical_info"
                                                data-range-id="grammatical-info">
                                            <option value="">Select part of speech</option>
                                        </select>
                                        <div class="form-text">Grammatical category for this sense.</div>
                                    </div>
                                    
                                    <!-- LIFT Ranges: Semantic Domain (sense-level) -->
                                    <div class="mb-3">
                                        <label class="form-label">Semantic Domain</label>
                                        <select class="form-select dynamic-lift-range" 
                                                name="senses[0].domain_type" 
                                                data-range-id="semantic-domain-ddp4" 
                                                data-hierarchical="true" 
                                                data-searchable="true"
                                                multiple>
                                            <option value="">Select semantic domain(s)</option>
                                        </select>
                                        <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
                                    </div>
                                    
                                    <!-- LIFT Ranges: Usage Type (sense-level) -->
                                    <div class="mb-3">
                                        <label class="form-label">Usage Type</label>
                                        <select class="form-select dynamic-lift-range" 
                                                name="senses[0].usage_type" 
                                                data-range-id="usage-type"
                                                data-hierarchical="true"
                                                data-searchable="true"
                                                multiple>
                                            <option value="">Select usage type(s)</option>
                                        </select>
                                        <div class="form-text">Usage classification for this sense (can select multiple).</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Sense Note</label>
                                        <textarea class="form-control" name="senses[0].note" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="examples-section mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                    data-sense-index="0">
                                                <i class="fas fa-plus"></i> Add Example
                                            </button>
                                        </div>
                                        
                                        <div class="examples-container">
                                            <div class="no-examples text-center text-muted py-3 border rounded">
                                                <p>No examples added yet</p>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="0">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-center mt-3" id="no-senses-message" style="display: none;">
                        <p class="text-muted">No senses added yet</p>
                        <button type="button" class="btn btn-primary" id="add-first-sense-btn">
                            <i class="fas fa-plus"></i> Add First Sense
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-primary" id="validate-btn">
                                <i class="fas fa-check-circle"></i> Validate
                            </button>
                            <button type="submit" class="btn btn-success" id="save-btn">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                            <div class="form-check form-check-inline ms-3">
                                <input class="form-check-input" type="checkbox" id="skip-validation-checkbox">
                                <label class="form-check-label" for="skip-validation-checkbox">
                                    <small>Skip validation (save partial work)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Templates for JavaScript -->
<template id="pronunciation-template">
    <div class="pronunciation-item mb-3 border-bottom pb-3">
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">IPA</label>
                <input type="text" class="form-control ipa-input" name="pronunciations[INDEX].value" 
                       value="" placeholder="IPA transcription">
            </div>
            <div class="col-md-4">
                <label class="form-label">Type</label>
                <input type="hidden" name="pronunciations[INDEX].type" value="seh-fonipa">
                <input type="text" class="form-control" value="seh-fonipa" disabled
                       title="Only seh-fonipa is supported for IPA pronunciations">
                <div class="form-text">International Phonetic Alphabet (IPA)</div>
            </div>
        </div>
        
        <div class="mt-2 mb-2">
            <label class="form-label">Audio File</label>
            <div class="input-group">
                <input type="text" class="form-control" name="pronunciations[INDEX].audio_path" 
                       value="" readonly placeholder="No audio file">
                <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                        data-index="INDEX" title="Upload audio file">
                    <i class="fas fa-upload"></i> Upload Audio
                </button>
            </div>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" 
                   id="pron-default-INDEX" name="pronunciations[INDEX].is_default">
            <label class="form-check-label" for="pron-default-INDEX">
                Default pronunciation
            </label>
        </div>
        
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                    data-index="INDEX">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    </div>
</template>

<template id="sense-template">
    <div class="sense-item card mb-4" data-sense-index="INDEX">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="drag-handle me-2" title="Drag to reorder" style="cursor: grab;">
                        <i class="fas fa-grip-vertical text-muted"></i>
                    </div>
                    <h6 class="mb-0">Sense NUMBER</h6>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-secondary move-sense-up" title="Move Up">↑</button>
                    <button type="button" class="btn btn-sm btn-secondary move-sense-down" title="Move Down">↓</button>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                            data-index="INDEX">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Hidden field for sense ID (will be populated when adding new senses) -->
            <input type="hidden" name="senses[INDEX].id" value="">
            
            <div class="mb-3">
                <label class="form-label">Definition <span class="text-danger">*</span></label>
                <div class="multilingual-forms definition-forms">
                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Language</label>
                                <select class="form-select language-select" 
                                        data-field-name="senses[INDEX].definition.{{ default_lang_code }}">
                                {# Language select without name attribute #}
                                    {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                    {% if default_lang_code not in project_lang_codes %}
                                        <option value="{{ default_lang_code }}" selected>{{ default_lang_code }} (original)</option>
                                    {% endif %}
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Definition Text</label>
                                <textarea class="form-control definition-text" 
                                          name="senses[INDEX].definition.{{ default_lang_code }}.text"
                                          rows="2" 
                                          required
                                          placeholder="Enter definition in {{ default_lang_code }}"></textarea>
                            </div>
                            <div class="col-md-1">
                                <!-- No remove button for primary language -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                            data-sense-index="INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Gloss</label>
                <div class="multilingual-forms gloss-forms">
                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Language</label>
                                <select class="form-select language-select" 
                                        data-field-name="senses[INDEX].gloss.{{ default_lang_code }}">
                                {# Language select without name attribute #}
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Gloss Text</label>
                                <input type="text" class="form-control gloss-text" 
                                       name="senses[INDEX].gloss.{{ default_lang_code }}.text"
                                       value=""
                                       placeholder="Enter gloss in {{ default_lang_code }}">
                            </div>
                            <div class="col-md-1">
                                <!-- No remove button for primary language -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                            data-sense-index="INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
                <div class="form-text">A short equivalent in another language.</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Part of Speech</label>
                <select class="form-select dynamic-grammatical-info" name="senses[INDEX].grammatical_info"
                        data-range-id="grammatical-info"
                        data-hierarchical="true"
                        data-searchable="true">
                    <option value="">Select part of speech</option>
                </select>
            </div>
            
            <!-- LIFT Ranges: Semantic Domain (sense-level) -->
            <div class="mb-3">
                <label class="form-label">Semantic Domain</label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[INDEX].domain_type" 
                        data-range-id="semantic-domain-ddp4" 
                        data-hierarchical="true" 
                        data-searchable="true"
                        multiple>
                    <option value="">Select semantic domain(s)</option>
                </select>
                <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
            </div>
            
            <!-- LIFT Ranges: Usage Type (sense-level) -->
            <div class="mb-3">
                <label class="form-label">Usage Type</label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[INDEX].usage_type" 
                        data-range-id="usage-type"
                        data-hierarchical="true"
                        data-searchable="true"
                        multiple>
                    <option value="">Select usage type(s)</option>
                </select>
                <div class="form-text">Usage classification for this sense (can select multiple).</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Sense Note</label>
                <textarea class="form-control" name="senses[INDEX].note" rows="2"></textarea>
            </div>
            
            <div class="examples-section mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-quote-left"></i> Examples</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                            data-sense-index="INDEX">
                        <i class="fas fa-plus"></i> Add Example
                    </button>
                </div>
                
                <div class="examples-container">
                    <div class="no-examples text-center text-muted py-3 border rounded">
                        <p>No examples added yet</p>
                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                data-sense-index="INDEX">
                            <i class="fas fa-plus"></i> Add Example
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="example-template">
    <div class="example-item card mb-3">
        <div class="card-header bg-light py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small>Example NUMBER</small>
                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn" 
                        data-sense-index="SENSE_INDEX" data-example-index="EXAMPLE_INDEX">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <label class="form-label">Example Text <span class="text-danger">*</span></label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].text" 
                          rows="2" required></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Translation</label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].translation" 
                          rows="2"></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Translation Type
                    <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Specify the type of translation: 'literal' for word-for-word translation, 'free' for natural/idiomatic translation."></i>
                    </span>
                </label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].translation_type"
                        data-range-id="translation-type"
                        data-hierarchical="false"
                        data-searchable="true">
                    <option value="">Select translation type</option>
                    <option value="literal">Literal</option>
                    <option value="free">Free/Idiomatic</option>
                </select>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Reference</label>
                <input type="text" class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].reference" 
                       value="">
            </div>
        </div>
    </div>
</template>

<!-- Validation Error Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="validationModalLabel">Validation Errors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="validation-errors-list">
                    <!-- Errors will be populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Select2 for enhanced dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Form serialization utilities -->
<script src="{{ url_for('static', filename='js/form-serializer.js') }}"></script>
<!-- Form state management -->
<script src="{{ url_for('static', filename='js/form-state-manager.js') }}"></script>
<!-- Client validation -->
<script src="{{ url_for('static', filename='js/client-validation-engine.js') }}"></script>
<!-- Auto-save functionality -->
<script src="{{ url_for('static', filename='js/auto-save-manager.js') }}"></script>
<!-- Validation UI -->
<script src="{{ url_for('static', filename='js/validation-ui.js') }}"></script>
<!-- Inline validation -->
<script src="{{ url_for('static', filename='js/inline-validation.js') }}"></script>
<!-- Ranges loader -->
<script src="{{ url_for('static', filename='js/ranges-loader.js') }}"></script>
<!-- SortableJS for drag-and-drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Pronunciation management -->
<script src="{{ url_for('static', filename='js/pronunciation-forms.js') }}"></script>
<!-- Variant relationships management -->
<script src="{{ url_for('static', filename='js/variant-forms.js') }}"></script>
<!-- Relations management -->
<script src="{{ url_for('static', filename='js/relations.js') }}"></script>
<!-- Etymology management -->
<script src="{{ url_for('static', filename='js/etymology-forms.js') }}"></script>
<!-- Multilingual fields management -->
<script src="{{ url_for('static', filename='js/multilingual-sense-fields.js') }}"></script>
<!-- Reordering manager for multi-item lists -->
<script src="{{ url_for('static', filename='js/reordering-manager.js') }}"></script>
<!-- Entry form functionality (must be last) -->
<script src="{{ url_for('static', filename='js/entry-form.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', async function() {
     // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    
    // Note: Range selects are automatically populated by ranges-loader.js
    // No manual range loading needed - just ensure data-range-id attributes are set
    
    // Initialize component managers after DOM is loaded
    
    // Initialize pronunciation manager (if it exists)
    if (window.PronunciationFormsManager && document.getElementById('pronunciation-container')) {
        // Initialize the manager without data. It should attach listeners to existing items.
        window.pronunciationFormsManager = new PronunciationFormsManager('pronunciation-container');
    }

    // Initialize variant forms manager
    if (window.VariantFormsManager && document.getElementById('variants-container')) {
        window.variantFormsManager = new VariantFormsManager('variants-container');
    }

    // Initialize relations manager
    if (window.RelationsManager && document.getElementById('relations-container')) {
        window.relationsManager = new RelationsManager('relations-container');
    }

    // Initialize etymology forms manager
    if (window.EtymologyFormsManager && document.getElementById('etymology-container')) {
        window.etymologyFormsManager = new EtymologyFormsManager('etymology-container', {
            rangeId: 'etymology'
        });
    }

    // Initialize multilingual notes manager
    if (window.MultilingualNotesManager && document.getElementById('notes-container')) {
        window.multilingualNotesManager = new MultilingualNotesManager('notes-container');
    }
    
    // Initialize SortableJS for senses    
    const sensesContainer = document.getElementById('senses-container');
    if (sensesContainer && typeof Sortable !== 'undefined') {
        new Sortable(sensesContainer, {
            animation: 150,
            handle: '.drag-handle',  // ← Use specific drag handle
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function(evt) {
                // Change cursor during drag
                document.body.style.cursor = 'grabbing';
            },
            onEnd: function (evt) {
                // Reset cursor
                document.body.style.cursor = '';
                // Reindex senses
                if (typeof reindexSenses === 'function') {
                    reindexSenses();
                }
            }
        });
    }   
});
</script>

<!-- Field Visibility Settings Modal -->
<div class="modal fade" id="fieldVisibilityModal" tabindex="-1" aria-labelledby="fieldVisibilityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldVisibilityModalLabel">
                    <i class="fas fa-cog"></i> Field Visibility Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Control which field sections are visible in the entry form. Settings are saved automatically.
                </p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Main Sections</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-basic-info" 
                                   data-target=".basic-info-section" checked>
                            <label class="form-check-label" for="show-basic-info">Basic Information</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-custom-fields" 
                                   data-target=".custom-fields-section" checked>
                            <label class="form-check-label" for="show-custom-fields">Custom Fields</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-notes" 
                                   data-target=".notes-section" checked>
                            <label class="form-check-label" for="show-notes">Entry Notes</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-pronunciation" 
                                   data-target=".pronunciation-section" checked>
                            <label class="form-check-label" for="show-pronunciation">Pronunciation</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Content Sections</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-variants" 
                                   data-target=".variants-section" checked>
                            <label class="form-check-label" for="show-variants">Variants</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-relations" 
                                   data-target=".relations-section" checked>
                            <label class="form-check-label" for="show-relations">Relations</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-senses" 
                                   data-target=".senses-section" checked>
                            <label class="form-check-label" for="show-senses">Senses & Definitions</label>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="reset-field-visibility">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary" id="hide-empty-sections">
                            <i class="fas fa-eye-slash"></i> Hide Empty Sections
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="show-all-sections">
                            <i class="fas fa-eye"></i> Show All Sections
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
