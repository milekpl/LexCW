{% extends "base.html" %}

{% block title %}{% if entry.id %}Edit Entry: {% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}{% else %}Add New Entry{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            {% if entry.id %}
            <i class="fas fa-edit"></i> Edit Entry: <span class="text-primary">{% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}</span>
            {% else %}
            <i class="fas fa-plus"></i> Add New Entry
            {% endif %}
        </h2>
    </div>
    <div class="col-md-4 text-end">
        {% if entry.id %}
        <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-eye"></i> View Entry
        </a>
        {% endif %}
        <a href="{{ url_for('main.entries') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list"></i> All Entries
        </a>
    </div>
</div>

<form id="entry-form" method="post" 
      action="{{ url_for('main.edit_entry', entry_id=entry.id) if entry.id else url_for('main.add_entry') }}">
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-book"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="lexical-unit" class="form-label">Lexical Unit <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lexical-unit" name="lexical_unit" 
                               value="{% if entry.lexical_unit is mapping %}{{ entry.lexical_unit.values()|join(', ') }}{% else %}{{ entry.lexical_unit }}{% endif %}" required>
                        <div class="form-text">The headword as it appears in the dictionary.</div>
                    </div>
                    
                    <!-- Homograph Number Display -->
                    {% if entry.homograph_number %}
                    <div class="mb-3">
                        <label for="homograph-number" class="form-label">Homograph Number</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="homograph-number" name="homograph_number" 
                                   value="{{ entry.homograph_number }}" readonly>
                            <span class="input-group-text">
                                <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" 
                                   title="Homograph numbers distinguish entries with the same lexical unit. This field is read-only and automatically assigned."></i>
                            </span>
                        </div>
                        <div class="form-text">Automatically assigned to distinguish homographs (entries sharing the same headword).</div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="citation-form" class="form-label">Citation Form</label>
                        <input type="text" class="form-control" id="citation-form" name="citation_form" 
                               value="{{ entry.citation_form }}">
                        <div class="form-text">Optional citation form if different from the headword.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="part-of-speech" class="form-label">Part of Speech <span class="text-danger">*</span></label>
                        <select class="form-select dynamic-grammatical-info" id="part-of-speech" name="grammatical_info.part_of_speech" required
                                data-selected="{% if entry.grammatical_info %}{{ entry.grammatical_info.part_of_speech }}{% endif %}"
                                data-range-id="grammatical-info">
                            <option value="">Select part of speech</option>
                            <!-- Options will be dynamically loaded from LIFT ranges -->
                        </select>
                    </div>

                    <!-- LIFT Ranges: Semantic Domain -->
                    <div class="mb-3">
                        <label for="semantic-domain-list" class="form-label">Semantic Domain</label>
                        <select class="form-select dynamic-lift-range" id="semantic-domain-ddp4" name="semantic_domain" 
                                data-range-id="semantic-domain-ddp4" 
                                data-hierarchical="true" 
                                data-searchable="true">
                            <option value="">Select semantic domain</option>
                        </select>
                    </div>

                    <!-- LIFT Ranges: Usage Type -->
                    <div class="mb-3">
                        <label for="usage-type" class="form-label">Usage Type</label>
                        <select class="form-select dynamic-lift-range" id="usage-type" name="usage_type" 
                                data-range-id="usage-type"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select usage type</option>
                        </select>
                    </div>

                    <!-- LIFT Ranges: Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select dynamic-lift-range" id="status" name="status" 
                                data-range-id="status"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select status</option>
                        </select>
                    </div>

                    <!-- LIFT Ranges: Morphological Type -->
                    <div class="mb-3">
                        <label for="morph-type" class="form-label">Morphological Type</label>
                        <select class="form-select dynamic-lift-range" id="morph-type" name="morph_type" 
                                data-range-id="morph-type"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select morphological type</option>
                        </select>
                    </div>


                    
                    <div class="mb-3">
                        <label for="etymology" class="form-label">Etymology</label>
                        <textarea class="form-control" id="etymology" name="etymology" rows="3">{{ entry.etymology }}</textarea>
                        <div class="form-text">Historical origin or derivation of the word.</div>
                    </div>
                </div>
            </div>
            
            <!-- Multilingual Notes Section -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-sticky-note"></i> Entry Notes</h5>
                </div>
                <div class="card-body">
                    <div id="notes-container">
                        <!-- Server-side rendered note items -->
                        {% if entry.notes %}
                            {% for note_type, note_content in entry.notes.items() %}
                            <div class="note-item mb-4 border rounded p-3" data-note-type="{{ note_type }}">
                                <div class="row align-items-center mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Note Type</label>
                                        <select class="form-select note-type-select" name="notes[{{ note_type }}][type]">
                                            <option value="general" {% if note_type == 'general' %}selected{% endif %}>General</option>
                                            <option value="usage" {% if note_type == 'usage' %}selected{% endif %}>Usage</option>
                                            <option value="semantic" {% if note_type == 'semantic' %}selected{% endif %}>Semantic</option>
                                            <option value="etymology" {% if note_type == 'etymology' %}selected{% endif %}>Etymology</option>
                                            <option value="cultural" {% if note_type == 'cultural' %}selected{% endif %}>Cultural</option>
                                            <option value="anthropology" {% if note_type == 'anthropology' %}selected{% endif %}>Anthropology</option>
                                            <option value="discourse" {% if note_type == 'discourse' %}selected{% endif %}>Discourse</option>
                                            <option value="phonology" {% if note_type == 'phonology' %}selected{% endif %}>Phonology</option>
                                            <option value="sociolinguistics" {% if note_type == 'sociolinguistics' %}selected{% endif %}>Sociolinguistics</option>
                                            <option value="bibliography" {% if note_type == 'bibliography' %}selected{% endif %}>Bibliography</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-note-btn" 
                                                title="Remove note">
                                            <i class="fas fa-trash"></i> Remove Note
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="multilingual-forms">
                                    {% if note_content is mapping %}
                                        <!-- Multilingual note -->
                                        {% for lang, text in note_content.items() %}
                                        <div class="mb-3 language-form" data-language="{{ lang }}">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-select" name="notes[{{ note_type }}][{{ lang }}][lang]">
                                                        <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
                                                        <option value="pt" {% if lang == 'pt' %}selected{% endif %}>Portuguese</option>
                                                        <option value="seh" {% if lang == 'seh' %}selected{% endif %}>Sena</option>
                                                        <option value="fr" {% if lang == 'fr' %}selected{% endif %}>French</option>
                                                        <option value="es" {% if lang == 'es' %}selected{% endif %}>Spanish</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-8">
                                                    <label class="form-label">Note Text</label>
                                                    <textarea class="form-control note-text" 
                                                              name="notes[{{ note_type }}][{{ lang }}][text]" 
                                                              rows="2" 
                                                              placeholder="Enter note text in {{ lang }}">{{ text }}</textarea>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-language-btn" 
                                                            title="Remove language">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Legacy single text note -->
                                        <div class="mb-3 language-form" data-language="en">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-select" name="notes[{{ note_type }}][en][lang]">
                                                        <option value="en" selected>English</option>
                                                        <option value="pt">Portuguese</option>
                                                        <option value="seh">Sena</option>
                                                        <option value="fr">French</option>
                                                        <option value="es">Spanish</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-8">
                                                    <label class="form-label">Note Text</label>
                                                    <textarea class="form-control note-text" 
                                                              name="notes[{{ note_type }}][en][text]" 
                                                              rows="2" 
                                                              placeholder="Enter note text in English">{{ note_content }}</textarea>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-language-btn" 
                                                            title="Remove language">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary add-language-btn" 
                                            title="Add another language">
                                        <i class="fas fa-plus"></i> Add Language
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no notes exist -->
                        {% if not entry.notes %}
                        <div class="text-muted mb-3" id="no-notes-message">
                            No notes added yet. Click "Add Note" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-microphone"></i> Pronunciation</h5>
                </div>
                <div class="card-body">
                    <div id="pronunciation-container">
                        <!-- Server-side rendered pronunciation items -->
                        {% if entry.pronunciations %}
                            {% for ws, pronunciation in entry.pronunciations.items() %}
                            <div class="pronunciation-item mb-3 border-bottom pb-3" data-index="{{ loop.index0 }}">
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label">IPA</label>
                                        <input type="text" class="form-control ipa-input" 
                                               name="pronunciations[{{ loop.index0 }}].value" 
                                               value="{{ pronunciation }}" 
                                               placeholder="IPA transcription">
                                        <input type="hidden" name="pronunciations[{{ loop.index0 }}].type" value="{{ ws }}">
                                        <div class="form-text">International Phonetic Alphabet (IPA)</div>
                                    </div>
                                </div>
                                
                                <div class="mt-2 mb-2">
                                    <label class="form-label">Audio File</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="pronunciations[{{ loop.index0 }}].audio_file" 
                                               value="" readonly 
                                               title="Audio file path" placeholder="No audio file">
                                        <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                                                data-index="{{ loop.index0 }}" title="Generate audio">
                                            <i class="fas fa-microphone"></i> Generate
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" 
                                           id="pron-default-{{ loop.index0 }}" name="pronunciations[{{ loop.index0 }}].is_default"
                                           {% if loop.index0 == 0 %}checked{% endif %}>
                                    <label class="form-check-label" for="pron-default-{{ loop.index0 }}">
                                        Default pronunciation
                                    </label>
                                </div>
                                
                                {% if loop.index0 > 0 %}
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                                            data-index="{{ loop.index0 }}" title="Remove pronunciation">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no pronunciations exist -->
                        {% if not entry.pronunciations %}
                        <div class="text-muted mb-3" id="no-pronunciations-message">
                            No pronunciations added yet. Click "Add Pronunciation" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-pronunciation-btn">
                        <i class="fas fa-plus"></i> Add Pronunciation
                    </button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-code-branch"></i> Variants</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-variant-btn">
                            <i class="fas fa-plus"></i> Add Variant
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="variants-container">
                        <!-- Server-side rendered variant items -->
                        {% if variant_relations %}
                            {% for variant in variant_relations %}
                            <div class="variant-item card mb-3" data-variant-index="{{ loop.index0 }}" data-direction="{{ variant.direction or 'outgoing' }}">
                                <div class="card-header {% if variant.direction == 'incoming' %}bg-info{% else %}bg-success{% endif %} text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas {% if variant.direction == 'incoming' %}fa-arrow-left{% else %}fa-arrow-right{% endif %} me-2"></i>
                                            {% if variant.direction == 'incoming' %}
                                                Has Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% else %}
                                                Is a Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% endif %}
                                        </h6>
                                        {% if variant.direction != 'incoming' %}
                                        <button type="button" class="btn btn-sm btn-light remove-variant-btn" 
                                                data-index="{{ loop.index0 }}" title="Remove variant">
                                            <i class="fas fa-trash text-danger"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    {% if variant.direction == 'incoming' %}
                                    <!-- Incoming: Other entries ARE variants of this entry (display only) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Entry that is a variant of this one</label>
                                            {% if variant.ref_display_text %}
                                            <div class="alert alert-light">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit this entry">
                                                        {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                    </a>
                                                </strong>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Entry Not Found: </strong>
                                                The entry ID "<code>{{ variant.ref }}</code>" could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect reference.</small>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-question-circle me-2"></i>
                                                <strong>No Entry Referenced</strong>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Variant Type</label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-info fs-6">{{ variant.variant_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Reverse Relationship:</strong> 
                                        {% if variant.ref_display_text %}
                                        The entry 
                                        "<strong>
                                            <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                               class="text-decoration-none">
                                                {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                            </a>
                                        </strong>" 
                                        is marked as a {{ variant.variant_type }} of this entry.
                                        {% elif variant.ref %}
                                        An entry with ID <code>{{ variant.ref }}</code> is marked as a {{ variant.variant_type }} of this entry, but the entry could not be found.
                                        {% else %}
                                        An unknown entry is marked as a {{ variant.variant_type }} of this entry.
                                        {% endif %}
                                        This relationship is defined in the other entry's data.
                                    </div>
                                    {% else %}
                                    <!-- Outgoing: This entry IS a variant of another (editable) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Target Entry</label>
                                            {% if variant.ref_display_text %}
                                            <!-- Show clickable link to target entry -->
                                            <div class="alert alert-light mb-2">
                                                <i class="fas fa-external-link-alt me-2"></i>
                                                <strong>This entry is a variant of: </strong>
                                                <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                   class="text-decoration-none text-primary fw-bold"
                                                   title="Edit target entry">
                                                    {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                </a>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger mb-2">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Target Entry Not Found: </strong>
                                                The referenced entry ID "<code>{{ variant.ref }}</code>" could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect ID.</small>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}][ref]"
                                                   value="{{ variant.ref or '' }}">
                                            
                                            <!-- Search interface for adding/changing variant targets -->
                                            <div class="input-group">
                                                <input type="text" class="form-control variant-search-input" 
                                                       placeholder="Search for entry to create variant relationship with..."
                                                       data-variant-index="{{ loop.index0 }}">
                                                <button type="button" class="btn btn-outline-secondary variant-search-btn" 
                                                        data-variant-index="{{ loop.index0 }}">
                                                    <i class="fas fa-search"></i> Search
                                                </button>
                                            </div>
                                            <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                            <div class="search-results mt-2" id="variant-search-results-{{ loop.index0 }}" style="display: none;"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Variant Type</label>
                                            <select class="form-control" 
                                                    name="variant_relations[{{ loop.index0 }}][variant_type]" required>
                                                <option value="">Select variant type</option>
                                                <option value="Spelling Variant" {% if variant.variant_type == 'Spelling Variant' %}selected{% endif %}>Spelling Variant</option>
                                                <option value="Dialectal Variant" {% if variant.variant_type == 'Dialectal Variant' %}selected{% endif %}>Dialectal Variant</option>
                                                <option value="Unspecified Variant" {% if variant.variant_type == 'Unspecified Variant' %}selected{% endif %}>Unspecified Variant</option>
                                                <option value="Stopień najwyższy" {% if variant.variant_type == 'Stopień najwyższy' %}selected{% endif %}>Stopień najwyższy</option>
                                                <option value="Plural Form" {% if variant.variant_type == 'Plural Form' %}selected{% endif %}>Plural Form</option>
                                                <option value="Past Tense" {% if variant.variant_type == 'Past Tense' %}selected{% endif %}>Past Tense</option>
                                            </select>
                                            <div class="form-text">Type of variant relationship</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Relation Type</label>
                                            <input type="text" class="form-control" 
                                                   name="variant_relations[{{ loop.index0 }}][type]"
                                                   value="{{ variant.type or '_component-lexeme' }}" 
                                                   readonly>
                                            <div class="form-text">LIFT relation type (typically "_component-lexeme")</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Order</label>
                                            <input type="number" class="form-control" 
                                                   name="variant_relations[{{ loop.index0 }}][order]"
                                                   value="{{ variant.order or loop.index0 }}" 
                                                   placeholder="0" min="0">
                                            <div class="form-text">Order of the relation</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Status</label>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-check-circle me-1"></i>Active Variant
                                                </span>
                                                <div class="form-text">This variant will be saved to the LIFT file</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Variant Relationship:</strong> This entry is a variant of 
                                        {% if variant.ref_display_text %}
                                        "<strong>
                                            <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                               class="text-decoration-none">
                                                {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                            </a>
                                        </strong>".
                                        {% elif variant.ref %}
                                        <span class="text-danger">a target entry that could not be found (ID: <code>{{ variant.ref }}</code>)</span>.
                                        {% else %}
                                        a target entry that needs to be specified.
                                        {% endif %}
                                        In LIFT format, this creates a relation with a variant-type trait.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Empty state when no variants exist -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-code-branch fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Variant Relations</h5>
                            <p class="text-muted">This entry does not have any variant relations defined.</p>
                            <p class="text-muted">
                                <strong>What are variants?</strong> Variants are different forms or spellings of the same lexical item, 
                                such as "protestor" vs "protester", or "Protestant ethic" vs "Protestant work ethic".
                            </p>
                            <p class="text-muted">
                                <strong>How variants work:</strong> Variants are stored as LIFT relations with variant-type traits. 
                                When you create a relation with a variant-type trait, it will appear here as a variant.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>About Variants:</strong> 
                        Variants represent different forms, spellings, or morphological variations of the same lexical item. 
                        Examples include "protestor" vs "protester", "Protestant ethic" vs "Protestant work ethic", 
                        or inflected forms like plurals and past tense forms.
                        <br><br>
                        <strong>Technical Note:</strong> Variants are stored as LIFT relations with variant-type traits.
                        This section displays only relations that have variant-type traits, making them distinct 
                        from other lexical relations shown in the Relations section below.
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-link"></i> Relations</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-relation-btn">
                            <i class="fas fa-plus"></i> Add Relation
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="relations-container">
                        <!-- Server-side rendered relation items -->
                        {% if entry.relations %}
                            {% set filtered_relations = [] %}
                            {% for relation in entry.relations %}
                                {% if not (relation.type == '_component-lexeme' and relation.traits and 'variant-type' in relation.traits) %}
                                    {% set _ = filtered_relations.append(relation) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if filtered_relations %}
                                {% for relation in filtered_relations %}
                                <div class="relation-item card mb-3" data-relation-index="{{ loop.index0 }}">
                                    <div class="card-header bg-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-link me-2"></i>
                                                Relation: {{ relation.type or 'Unknown Type' }}
                                            </h6>
                                            <button type="button" class="btn btn-sm btn-light remove-relation-btn" 
                                                    data-index="{{ loop.index0 }}" title="Remove relation">
                                                <i class="fas fa-trash text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold">Relation Type</label>
                                                <select class="form-control relation-type-select" 
                                                        name="relations[{{ loop.index0 }}][type]" 
                                                        data-range-id="lexical-relation"
                                                        data-hierarchical="true"
                                                        data-searchable="true"
                                                        required>
                                                    <option value="">Select type</option>
                                                    <!-- Options will be populated dynamically from LIFT ranges -->
                                                </select>
                                                <div class="form-text">Type of semantic relation</div>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label fw-bold">Target Entry</label>
                                                {% if relation.ref_display_text %}
                                                <!-- Show clickable link to target entry -->
                                                <div class="alert alert-light mb-2">
                                                    <i class="fas fa-external-link-alt me-2"></i>
                                                    <strong>Related to: </strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=relation.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit target entry">
                                                        {{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}
                                                    </a>
                                                </div>
                                                {% endif %}
                                                
                                                <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                                <input type="hidden" 
                                                       name="relations[{{ loop.index0 }}][ref]"
                                                       value="{{ relation.ref or '' }}">
                                                
                                                <!-- Search interface for adding/changing relations -->
                                                <div class="input-group">
                                                    <input type="text" class="form-control relation-search-input" 
                                                           placeholder="Search for entry to relate to..."
                                                           data-relation-index="{{ loop.index0 }}">
                                                    <button type="button" class="btn btn-outline-secondary relation-search-btn" 
                                                            data-relation-index="{{ loop.index0 }}">
                                                        <i class="fas fa-search"></i> Search
                                                    </button>
                                                </div>
                                                <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                                <div class="search-results mt-2" id="search-results-{{ loop.index0 }}" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info mt-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Semantic Relationship:</strong> This entry has a "{{ relation.type }}" relationship with 
                                            {% if relation.ref_display_text %}
                                            "<strong>
                                                <a href="{{ url_for('main.edit_entry', entry_id=relation.ref) }}" 
                                                   class="text-decoration-none">
                                                    {{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}
                                                </a>
                                            </strong>".
                                            {% else %}
                                            the target entry.
                                            {% endif %}
                                            In LIFT format, this creates a relation element with the specified type.
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <!-- Empty state when no non-variant relations exist -->
                            <div class="empty-state text-center py-4">
                                <i class="fas fa-link fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Semantic Relations</h5>
                                <p class="text-muted">This entry does not have any semantic relations defined.</p>
                                <p class="text-muted">
                                    <strong>What are relations?</strong> Relations connect this entry to other entries through semantic relationships 
                                    like synonymy, antonymy, hyponymy, etc. These help build the semantic network of the dictionary.
                                </p>
                                <p class="text-muted">
                                    <strong>How relations work:</strong> Relations are stored as LIFT relation elements. 
                                    They differ from variants, which represent different forms of the same lexical item.
                                </p>
                            </div>
                            {% endif %}
                        {% else %}
                        <!-- Empty state when no relations exist at all -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-link fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Semantic Relations</h5>
                            <p class="text-muted">This entry does not have any semantic relations defined.</p>
                            <p class="text-muted">
                                <strong>What are relations?</strong> Relations connect this entry to other entries through semantic relationships 
                                like synonymy, antonymy, hyponymy, etc. These help build the semantic network of the dictionary.
                            </p>
                            <p class="text-muted">
                                <strong>How relations work:</strong> Relations are stored as LIFT relation elements. 
                                They differ from variants, which represent different forms of the same lexical item.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>About Relations:</strong> 
                        Relations represent semantic connections between different lexical entries. 
                        Examples include synonyms (words with similar meanings), antonyms (opposite meanings), 
                        hyponyms (specific instances of a general term), and hypernyms (general terms for specific instances).
                        <br><br>
                        <strong>Technical Note:</strong> Relations are stored as LIFT relation elements.
                        This section displays semantic relations between lexical entries, which are distinct 
                        from variants that represent different forms of the same lexical item.
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Etymology</h5>
                        <small class="text-muted">Historical word origin and development</small>
                    </div>
                </div>
                <div class="card-body">
                    <div id="etymology-container">
                        <!-- Etymology forms will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Senses</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-sense-btn">
                            <i class="fas fa-plus"></i> Add Sense
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="senses-container">
                        {% if entry.senses %}
                            {% for sense in entry.senses %}
                                <div class="sense-item card mb-4" data-sense-index="{{ loop.index0 }}">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Sense {{ loop.index }}</h6>
                                            {% if loop.index > 1 %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                                                        data-index="{{ loop.index0 }}">
                                                    <i class="fas fa-trash"></i> Remove
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Definition <span class="text-danger">*</span></label>
                                            <textarea class="form-control" name="senses[{{ loop.index0 }}].definition" 
                                                      rows="2" required>{{ sense.definition }}</textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Gloss</label>
                                            <input type="text" class="form-control" name="senses[{{ loop.index0 }}].gloss" 
                                                   value="{{ sense.gloss }}">
                                            <div class="form-text">A short equivalent in another language.</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="part-of-speech" class="form-label">Part of Speech</label>
                                            <select class="form-select dynamic-grammatical-info" name="senses[{{ loop.index0 }}].grammatical_info"
                                                    data-selected="{{ sense.grammatical_info }}"
                                                    data-range-id="grammatical-info">
                                                <option value="">Select part of speech</option>
                                            </select>
                                            <div class="form-text">Grammatical category for this sense.</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Sense Note</label>
                                            <textarea class="form-control" name="senses[{{ loop.index0 }}].note" 
                                                      rows="2">{{ sense.note }}</textarea>
                                        </div>
                                        
                                        <div class="examples-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="{{ loop.index0 }}">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                            
                                            <div class="examples-container">
                                                {% if sense.examples %}
                                                {% for example in sense.examples %}
                                                    <div class="example-item card mb-3" data-example-index="{{ loop.index0 }}">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <h6 class="mb-0">Example {{ loop.index }}</h6>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn"
                                                                        data-sense-index="0" data-example-index="{{ loop.index0 }}">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Example Sentence</label>
                                                                <textarea class="form-control" name="senses[0].examples[{{ loop.index0 }}].sentence"
                                                                          rows="2">{{ example.sentence }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Translation</label>
                                                                <textarea class="form-control" name="senses[0].examples[{{ loop.index0 }}].translation"
                                                                          rows="2">{{ example.translation }}</textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="no-examples text-center text-muted py-3 border rounded">
                                                        <p>No examples added yet</p>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                                data-sense-index="{{ loop.index0 }}">
                                                            <i class="fas fa-plus"></i> Add Example
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="sense-item card mb-4" data-sense-index="0">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Sense 1</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Definition <span class="text-danger">*</span></label>
                                        <textarea class="form-control" name="senses[0].definition" 
                                                  rows="2" required></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Gloss</label>
                                        <input type="text" class="form-control" name="senses[0].gloss" value="">
                                        <div class="form-text">A short equivalent in another language.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Part of Speech</label>
                                        <select class="form-select dynamic-grammatical-info" name="senses[0].grammatical_info"
                                                data-range-id="grammatical-info">
                                            <option value="">Select part of speech</option>
                                        </select>
                                        <div class="form-text">Grammatical category for this sense.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Sense Note</label>
                                        <textarea class="form-control" name="senses[0].note" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="examples-section mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                    data-sense-index="0">
                                                <i class="fas fa-plus"></i> Add Example
                                            </button>
                                        </div>
                                        
                                        <div class="examples-container">
                                            <div class="no-examples text-center text-muted py-3 border rounded">
                                                <p>No examples added yet</p>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="0">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-center mt-3" id="no-senses-message" style="display: none;">
                        <p class="text-muted">No senses added yet</p>
                        <button type="button" class="btn btn-primary" id="add-first-sense-btn">
                            <i class="fas fa-plus"></i> Add First Sense
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-primary" id="validate-btn">
                                <i class="fas fa-check-circle"></i> Validate
                            </button>
                            <button type="submit" class="btn btn-success" id="save-btn">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Templates for JavaScript -->
<template id="pronunciation-template">
    <div class="pronunciation-item mb-3 border-bottom pb-3">
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">IPA</label>
                <input type="text" class="form-control" name="pronunciations[INDEX].value" 
                       value="" placeholder="IPA transcription">
            </div>
            <div class="col-md-4">
                <label class="form-label">Type</label>
                <input type="hidden" name="pronunciations[INDEX].type" value="seh-fonipa">
                <input type="text" class="form-control" value="seh-fonipa" disabled
                       title="Only seh-fonipa is supported for IPA pronunciations">
                <div class="form-text">International Phonetic Alphabet (IPA)</div>
            </div>
        </div>
        
        <div class="mt-2 mb-2">
            <label class="form-label">Audio File</label>
            <div class="input-group">
                <input type="text" class="form-control" name="pronunciations[INDEX].audio_file" 
                       value="" readonly>
                <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                        data-index="INDEX">
                    <i class="fas fa-microphone"></i> Generate
                </button>
            </div>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" 
                   id="pron-default-INDEX" name="pronunciations[INDEX].is_default">
            <label class="form-check-label" for="pron-default-INDEX">
                Default pronunciation
            </label>
        </div>
        
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                    data-index="INDEX">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    </div>
</template>

<template id="sense-template">
    <div class="sense-item card mb-4" data-sense-index="INDEX">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Sense NUMBER</h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                        data-index="INDEX">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Definition <span class="text-danger">*</span></label>
                <textarea class="form-control" name="senses[INDEX].definition" 
                          rows="2" required></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Gloss</label>
                <input type="text" class="form-control" name="senses[INDEX].gloss" value="">
                <div class="form-text">A short equivalent in another language.</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Part of Speech</label>
                <select class="form-select dynamic-grammatical-info" name="senses[INDEX].grammatical_info"
                        data-range-id="grammatical-info"
                        data-hierarchical="true"
                        data-searchable="true">
                    <option value="">Select part of speech</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Sense Note</label>
                <textarea class="form-control" name="senses[INDEX].note" rows="2"></textarea>
            </div>
            
            <div class="examples-section mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-quote-left"></i> Examples</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                            data-sense-index="INDEX">
                        <i class="fas fa-plus"></i> Add Example
                    </button>
                </div>
                
                <div class="examples-container">
                    <div class="no-examples text-center text-muted py-3 border rounded">
                        <p>No examples added yet</p>
                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                data-sense-index="INDEX">
                            <i class="fas fa-plus"></i> Add Example
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="example-template">
    <div class="example-item card mb-3">
        <div class="card-header bg-light py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small>Example NUMBER</small>
                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn" 
                        data-sense-index="SENSE_INDEX" data-example-index="EXAMPLE_INDEX">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <label class="form-label">Example Text <span class="text-danger">*</span></label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].text" 
                          rows="2" required></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Translation</label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].translation" 
                          rows="2"></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Reference</label>
                <input type="text" class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].reference" 
                       value="">
            </div>
        </div>
    </div>
</template>

<!-- Validation Error Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="validationModalLabel">Validation Errors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="validation-errors-list">
                    <!-- Errors will be populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Audio Preview Modal -->
<div class="modal fade" id="audioPreviewModal" tabindex="-1" aria-labelledby="audioPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="audioPreviewModalLabel">Audio Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <audio id="audio-preview-player" controls>
                        Your browser does not support the audio element.
                    </audio>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" id="save-audio-btn">
                        <i class="fas fa-save"></i> Save Audio
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/ranges-loader.js') }}"></script>
<script src="{{ url_for('static', filename='js/pronunciation-forms.js') }}"></script>
<script src="{{ url_for('static', filename='js/variant-forms.js') }}"></script>
<script src="{{ url_for('static', filename='js/relations.js') }}"></script>
<script src="{{ url_for('static', filename='js/etymology-forms.js') }}"></script>
<script src="{{ url_for('static', filename='js/entry-form.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Note: Range selects are automatically populated by ranges-loader.js
    // No manual range loading needed - just ensure data-range-id attributes are set
    
    // Initialize component managers after DOM is loaded
    
    // Initialize pronunciation forms manager
    if (window.PronunciationFormsManager && document.getElementById('pronunciation-container')) {
        // Get pronunciation data - ensure it's always an object
        const pronunciationData = {{ entry.pronunciations | default({}) | tojson | safe }};
        
        console.log('[DEBUG] Pronunciation data:', pronunciationData);
        
        // Convert dictionary format to array format expected by PronunciationFormsManager
        const pronunciationArray = [];
        
        // Handle different data formats
        if (pronunciationData) {
            if (Array.isArray(pronunciationData)) {
                // Already an array - use as is
                pronunciationArray.push(...pronunciationData);
            } else if (typeof pronunciationData === 'object') {
                // Dictionary format - convert to array
                for (const [writingSystem, value] of Object.entries(pronunciationData)) {
                    if (value && value.trim()) {  // Only add non-empty values
                        pronunciationArray.push({
                            type: writingSystem,
                            value: value,
                            audio_file: "",
                            is_default: true
                        });
                    }
                }
            }
        }
        
        console.log('[DEBUG] Pronunciation array:', pronunciationArray);
        console.log('[DEBUG] Container:', document.getElementById('pronunciation-container'));
        
        // Hide the "no pronunciations" message if pronunciations exist
        const noPronunciationsMessage = document.getElementById('no-pronunciations-message');
        const existingItems = document.querySelectorAll('.pronunciation-item');
        if (noPronunciationsMessage && existingItems.length > 0) {
            noPronunciationsMessage.style.display = 'none';
        }
        
        // Always initialize the pronunciation manager
        window.pronunciationFormsManager = new PronunciationFormsManager('pronunciation-container', {
            pronunciations: pronunciationArray
        });
        
        console.log('[DEBUG] Pronunciation manager created:', window.pronunciationFormsManager);
    } else {
        console.log('[DEBUG] Pronunciation initialization failed:');
        console.log('  PronunciationFormsManager available:', !!window.PronunciationFormsManager);
        console.log('  Container available:', !!document.getElementById('pronunciation-container'));
    }
    
    console.log('[TEMPLATE DEBUG] Script execution starting...');
    console.log('[TEMPLATE DEBUG] VariantFormsManager available:', typeof window.VariantFormsManager);
    console.log('[TEMPLATE DEBUG] variants-container exists:', !!document.getElementById('variants-container'));
    
    // Wrap in setTimeout to ensure all scripts are loaded
    setTimeout(function() {
        console.log('[TEMPLATE DEBUG] setTimeout execution - VariantFormsManager available:', typeof window.VariantFormsManager);
        
        // Initialize variant forms manager
        if (window.VariantFormsManager && document.getElementById('variants-container')) {
            // Pass variant_relations data to JavaScript with safe fallback
            try {
                const variantRelations = {{ (variant_relations or []) | tojson | safe }};
                window.variantRelations = variantRelations;
            } catch (error) {
                console.warn('[TEMPLATE DEBUG] Failed to load variant relations:', error);
                window.variantRelations = [];
            }
            
            console.log('[TEMPLATE DEBUG] Initializing VariantFormsManager...');
            window.variantFormsManager = new VariantFormsManager('variants-container');
            console.log('[TEMPLATE DEBUG] VariantFormsManager initialized:', !!window.variantFormsManager);
            
            // Force re-render after a small delay to ensure everything is loaded
            setTimeout(() => {
                // Only force render if the container is empty (no server-side content)
                const container = document.getElementById('variants-container');
                const hasServerSideContent = container && container.querySelector('.variant-item');
                
                console.log('[TEMPLATE DEBUG] Container has server-side content:', !!hasServerSideContent);
                
                if (window.variantFormsManager && window.variantFormsManager.forceRender && !hasServerSideContent) {
                    console.log('[TEMPLATE DEBUG] Calling forceRender() because no server-side content found');
                    window.variantFormsManager.forceRender();
                } else if (hasServerSideContent) {
                    console.log('[TEMPLATE DEBUG] Skipping forceRender() because server-side content exists');
                } else {
                    console.log('[TEMPLATE DEBUG] forceRender() not available or container not found');
                }
            }, 50);
        } else {
            console.log('[TEMPLATE DEBUG] Variant forms manager initialization failed:');
            console.log('  VariantFormsManager available:', !!window.VariantFormsManager);
            console.log('  Container available:', !!document.getElementById('variants-container'));
        }
    }, 100); // Small delay to ensure all scripts are loaded

    // Initialize relations manager with a small delay to ensure all scripts are loaded
    setTimeout(function() {
        if (window.RelationsManager && document.getElementById('relations-container')) {
            {% if entry.relations %}
                {% set relations_data = [] %}
                {% for relation in entry.relations %}
                    {% set relation_dict = {'type': relation.type, 'ref': relation.ref} %}
                    {% set _ = relations_data.append(relation_dict) %}
                {% endfor %}
                const relations = {{ relations_data | tojson | safe }};
            {% else %}
                const relations = [];
            {% endif %}
            window.relationsManager = new RelationsManager('relations-container', {
                relations: relations
            });
            console.log('RelationsManager initialized successfully');
        } else {
            console.log('RelationsManager initialization failed:');
            console.log('  RelationsManager available:', !!window.RelationsManager);
            console.log('  Container available:', !!document.getElementById('relations-container'));
        }
    }, 100); // Small delay to ensure all scripts are loaded

    // Initialize etymology forms manager
    if (window.EtymologyFormsManager && document.getElementById('etymology-container')) {
        const etymologies = {{ entry.etymologies | tojson | safe }} || [];
        window.etymologyFormsManager = new EtymologyFormsManager('etymology-container', {
            etymologies: etymologies,
            rangeId: 'etymology-types'
        });
    }

    // Initialize multilingual notes manager
    if (window.MultilingualNotesManager && document.getElementById('notes-container')) {
        {% set notes_data = entry.notes or {} %}
        const notesData = {{ notes_data | tojson | safe }};
        window.multilingualNotesManager = new MultilingualNotesManager('notes-container', {
            notes: notesData
        });
    }
});
</script>
{% endblock %}
