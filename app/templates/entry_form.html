{% extends "base.html" %}

{% block title %}{% if entry.id %}Edit Entry: {{ entry.lexical_unit.values()|join(', ') }}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}{% else %}Add New Entry{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/form-tooltips.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/validation-feedback.css') }}">
{% endblock %}



{% block content %}
{% if validation_result and not validation_result.is_valid %}
<!-- Validation Guidance Section -->
<div class="alert alert-warning mb-4" role="alert">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Entry Validation Guidance</h5>
    <p class="mb-3">This entry has validation issues that should be addressed. You can still edit and save the entry, but fixing these issues will improve data quality.</p>
    
    {% if validation_result.errors %}
    <div class="validation-errors mb-3">
        <h6><i class="fas fa-times-circle text-danger"></i> Critical Issues:</h6>
        <ul class="mb-0">
        {% for error in validation_result.errors %}
            <li class="text-danger">{{ error.message }} <small class="text-muted">({{ error.rule_id }})</small></li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if validation_result.warnings %}
    <div class="validation-warnings">
        <h6><i class="fas fa-exclamation-circle text-warning"></i> Warnings:</h6>
        <ul class="mb-0">
        {% for warning in validation_result.warnings %}
            <li class="text-warning">{{ warning.message }} <small class="text-muted">({{ warning.rule_id }})</small></li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            {% if entry.id %}
            <i class="fas fa-edit"></i> Edit Entry: <span class="text-primary">{{ entry.lexical_unit.values()|join(', ') }}{% if entry.homograph_number %}<sub>{{ entry.homograph_number }}</sub>{% endif %}</span>
            {% else %}
            <i class="fas fa-plus"></i> Add New Entry
            {% endif %}
        </h2>
    </div>
    <div class="col-md-4 text-end">
        <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#fieldVisibilityModal">
            <i class="fas fa-cog"></i> Field Settings
        </button>
        {% if entry.id %}
        <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-eye"></i> View Entry
        </a>
        {% endif %}
        <a href="{{ url_for('main.entries') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list"></i> All Entries
        </a>
    </div>
</div>

{% set source_lang = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS and current_app.config.PROJECT_SETTINGS.source_language else 'en' %}
<form id="entry-form" method="post" data-source-language="{{ source_lang }}" novalidate>
    {% if entry.id %}
        <input type="hidden" name="id" value="{{ entry.id }}">
    {% endif %}
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 basic-info-section">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-book"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Lexical Unit <span class="text-danger">*</span></label>
                        <div class="multilingual-forms lexical-unit-forms">
                            {% set default_lang_code = current_app.config_manager.get_source_language().code if current_app and current_app.config_manager else 'en' %}
                            {% if entry.lexical_unit %}
                                {% for lang_code, text in entry.lexical_unit.items() %}
                                    <div class="mb-2 language-form" data-language="{{ lang_code }}">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Language</label>
                                                <select class="form-select language-select" 
                                                        name="lexical_unit_lang.{{ lang_code }}"
                                                        data-current-lang="{{ lang_code }}">
                                                    {% for code, label in project_languages %}
                                                        <option value="{{ code }}" {% if code == lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label">Headword Text</label>
                                                <input type="text" class="form-control lexical-unit-text" 
                                                       name="lexical_unit.{{ lang_code }}"
                                                       value="{{ text }}"
                                                       {% if lang_code == default_lang_code %}required{% endif %}
                                                       placeholder="Enter headword in {{ lang_code }}">
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                {% if lang_code != default_lang_code %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-lexical-unit-language-btn" 
                                                            title="Remove language">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="mb-2 language-form" data-language="{{ default_lang_code }}">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Language</label>
                                            <select class="form-select language-select" 
                                                    name="lexical_unit_lang.{{ default_lang_code }}"
                                                    data-current-lang="{{ default_lang_code }}">
                                                {% for code, label in project_languages %}
                                                    <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Headword Text</label>
                                            <input type="text" class="form-control lexical-unit-text" 
                                                   name="lexical_unit.{{ default_lang_code }}"
                                                   required
                                                   placeholder="Enter headword in {{ default_lang_code }}">
                                        </div>
                                        <div class="col-md-1">
                                            <!-- No remove button for primary language -->
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2 add-lexical-unit-language-btn">
                            <i class="fas fa-plus"></i> Add Translation
                        </button>
                        <div class="form-text">The headword as it appears in the dictionary.</div>
                    </div>

                    <!-- Homograph Number Display - Only show if entry has a homograph number -->
                    {% if entry.homograph_number %}
                    <div class="mb-3">
                        <label for="homograph-number" class="form-label">
                            Homograph Number
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="This entry is assigned homograph number {{ entry.homograph_number }} to distinguish it from other entries with the same lexical unit."></i>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="homograph-number" name="homograph_number" 
                               value="{{ entry.homograph_number }}" readonly>
                        <div class="form-text">Automatically assigned to distinguish homographs (entries sharing the same headword).</div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="citation-form" class="form-label">Citation Form</label>
                        <input type="text" class="form-control" id="citation-form" name="citation_form" 
                               value="{{ entry.citation_form }}">
                        <div class="form-text">Optional citation form if different from the headword.</div>
                    </div>

                    <div class="mb-3">
                        <label for="part-of-speech" class="form-label">
                            Part of Speech <span class="text-muted" id="pos-required-indicator" style="display: none;">*</span>
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                                   title="This field is automatically inherited from senses. If all senses have the same grammatical category, it will be set automatically. If there are discrepancies, you'll need to resolve them manually."></i>
                            </span>
                        </label>
                        <select class="form-select dynamic-grammatical-info" id="part-of-speech" name="grammatical_info.part_of_speech"
                                data-selected="{% if entry.grammatical_info %}{{ entry.grammatical_info }}{% endif %}"
                                data-range-id="grammatical-info">
                            <option value="">Select part of speech</option>
                            <!-- Options will be dynamically loaded from LIFT ranges -->
                        </select>
                    </div>

                    <!-- LIFT Ranges: Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select dynamic-lift-range" id="status" name="status" 
                                data-range-id="status"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select status</option>
                        </select>
                    </div>

                    <!-- LIFT Ranges: Morphological Type -->
                    <div class="mb-3">
                        <label for="morph-type" class="form-label">
                            Morphological Type
                            <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="Automatically classified based on headword form: contains whitespace=phrase, ends with hyphen=prefix, starts with hyphen=suffix, both=infix, default=stem."></i>
                            </span>
                        </label>
                        <select class="form-select dynamic-lift-range" id="morph-type" name="morph_type"
                                data-range-id="morph-type"
                                data-selected="{% if entry.morph_type %}{{ entry.morph_type }}{% endif %}"
                                data-hierarchical="true"
                                data-searchable="true">
                            <option value="">Select morphological type</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Custom Fields Section -->
            {% if entry.custom_fields %}
            <div class="card mb-4 custom-fields-section">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-cogs"></i> Custom Fields 
                        <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                            <i class="fas fa-info-circle text-white" data-bs-toggle="tooltip" data-bs-placement="top" 
                               title="Custom fields defined in the LIFT data. These fields contain additional metadata and domain-specific information not covered by standard LIFT elements."></i>
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for field_type, field_content in entry.custom_fields.items() %}
                    <div class="custom-field-item mb-4 border rounded p-3 bg-light" data-field-type="{{ field_type }}">
                        <div class="row align-items-center mb-2">
                            <div class="col-md-8">
                                <label class="form-label fw-bold text-capitalize">{{ field_type|replace('_', ' ')|title }}</label>
                                <small class="text-muted d-block">Field Type: {{ field_type }}</small>
                            </div>
                        </div>
                        
                        <!-- Multilingual custom field (always dict format) -->
                        <div class="multilingual-forms">
                            {% for lang, text in field_content.items() %}
                            <div class="mb-3 language-form" data-language="{{ lang }}">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Language</label>
                                        <input type="text" class="form-control bg-white" value="{{ lang }}" readonly>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label">Content</label>
                                        <textarea class="form-control" 
                                                  name="custom_fields[{{ field_type }}][{{ lang }}]" 
                                                  rows="2">{{ text }}</textarea>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Multilingual Notes Section -->
            <div class="card mb-4 notes-section">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-sticky-note"></i> Entry Notes</h5>
                </div>
                <div class="card-body">
                    <div id="notes-container">
                        <!-- Server-side rendered note items -->
                        {% if entry.notes %}
                            {% for note_type, note_content in entry.notes.items() %}
                            <div class="note-item mb-4 border rounded p-3" data-note-type="{{ note_type }}">
                                <div class="row align-items-center mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Note Type</label>
                                        <select class="form-select note-type-select" name="notes.{{ note_type }}.type">
                                            <option value="general" {% if note_type == 'general' %}selected{% endif %}>General</option>
                                            <option value="usage" {% if note_type == 'usage' %}selected{% endif %}>Usage</option>
                                            <option value="semantic" {% if note_type == 'semantic' %}selected{% endif %}>Semantic</option>
                                            <option value="etymology" {% if note_type == 'etymology' %}selected{% endif %}>Etymology</option>
                                            <option value="cultural" {% if note_type == 'cultural' %}selected{% endif %}>Cultural</option>
                                            <option value="anthropology" {% if note_type == 'anthropology' %}selected{% endif %}>Anthropology</option>
                                            <option value="discourse" {% if note_type == 'discourse' %}selected{% endif %}>Discourse</option>
                                            <option value="phonology" {% if note_type == 'phonology' %}selected{% endif %}>Phonology</option>
                                            <option value="sociolinguistics" {% if note_type == 'sociolinguistics' %}selected{% endif %}>Sociolinguistics</option>
                                            <option value="bibliography" {% if note_type == 'bibliography' %}selected{% endif %}>Bibliography</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-note-btn" 
                                                title="Remove note">
                                            <i class="fas fa-trash"></i> Remove Note
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="multilingual-forms">
                                    <!-- Multilingual note (always dict format) -->
                                    {% for lang, text in note_content.items() %}
                                    <div class="mb-3 language-form" data-language="{{ lang }}">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Language</label>
                                                <select class="form-select language-select" name="notes.{{ note_type }}.{{ lang }}.lang">
                                                    {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                    {% if lang not in project_lang_codes %}
                                                        <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                    {% endif %}
                                                    {% for code, label in project_languages %}
                                                        <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label">Note Text</label>
                                                <textarea class="form-control note-text" 
                                                          name="notes.{{ note_type }}.{{ lang }}.text" 
                                                          rows="2" 
                                                          placeholder="Enter note text in {{ lang }}">{{ text }}</textarea>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-language-btn" 
                                                        title="Remove language">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary add-language-btn" 
                                            title="Add another language">
                                        <i class="fas fa-plus"></i> Add Language
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no notes exist -->
                        {% if not entry.notes %}
                        <div class="text-muted mb-3" id="no-notes-message">
                            No notes added yet. Click "Add Note" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-note-btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
            </div>
            
            <div class="card mb-4 pronunciation-section">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-microphone"></i> Pronunciation</h5>
                </div>
                <div class="card-body">
                    <div id="pronunciation-container">
                        <!-- Server-side rendered pronunciation items -->
                        {% if entry.pronunciations %}
                            {% for ws, pronunciation in entry.pronunciations.items() %}
                            <div class="pronunciation-item mb-3 border-bottom pb-3" data-index="{{ loop.index0 }}">
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label">IPA</label>
                                        <input type="text" class="form-control ipa-input" 
                                               name="pronunciations[{{ loop.index0 }}].value" 
                                               value="{{ pronunciation }}" 
                                               placeholder="IPA transcription">
                                        <input type="hidden" name="pronunciations[{{ loop.index0 }}].type" value="{{ ws }}">
                                        <div class="form-text">International Phonetic Alphabet (IPA)</div>
                                    </div>
                                </div>
                                
                                <div class="mt-2 mb-2">
                                    <label class="form-label">Audio File</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="pronunciations[{{ loop.index0 }}].audio_path" 
                                               value="{{ pronunciation.audio_path if pronunciation.audio_path else '' }}" readonly 
                                               title="Audio file path" placeholder="No audio file">
                                        <button class="btn btn-outline-secondary upload-audio-btn" type="button" 
                                                data-index="{{ loop.index0 }}" title="Upload audio file">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                        <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                                                data-index="{{ loop.index0 }}" title="Generate audio from IPA">
                                            <i class="fas fa-magic"></i> Generate
                                        </button>
                                    </div>
                                    
                                    <!-- Show existing audio preview if audio file exists -->
                                    {% if pronunciation.audio_path %}
                                    <div class="audio-preview mt-2">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">Audio file: {{ pronunciation.audio_path }}</small>
                                                <audio controls class="w-100 mt-1" preload="metadata">
                                                    <source src="{{ url_for('static', filename='audio/' + pronunciation.audio_path) }}">
                                                    Your browser does not support the audio element.
                                                </audio>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-audio-btn" 
                                                    title="Remove audio file">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- LIFT 0.13: CV Pattern (Day 40) -->
                                <div class="mt-3 mb-2">
                                    <label class="form-label">
                                        CV Pattern
                                        <i class="fas fa-info-circle ms-1 form-tooltip" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top"
                                           data-bs-html="true"
                                           title="<strong>About CV Pattern:</strong><br>Consonant-Vowel syllable structure pattern (e.g., CV, CVC, CVCC). Useful for phonological analysis."></i>
                                    </label>
                                    <div class="multilingual-forms cv-pattern-forms" data-pron-index="{{ loop.index0 }}">
                                        {% if entry.pronunciation_cv_pattern %}
                                            {% for lang, text in entry.pronunciation_cv_pattern.items() %}
                                                <div class="language-form-group mb-2 border rounded p-2" data-lang="{{ lang }}">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <label class="form-label small">Language</label>
                                                            <select class="form-select form-select-sm language-selector" 
                                                                    name="pronunciations[{{ loop.index0 }}].cv_pattern.{{ lang }}.lang"
                                                                    data-field-name="pronunciations[{{ loop.index0 }}].cv_pattern.{{ lang }}">
                                                                <option value="">Select language</option>
                                                                {% for available_lang in available_languages %}
                                                                    <option value="{{ available_lang }}" {% if lang == available_lang %}selected{% endif %}>{{ available_lang }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-9">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <label class="form-label small">Pattern</label>
                                                                    <input type="text" class="form-control form-control-sm cv-pattern-text" 
                                                                           name="pronunciations[{{ loop.index0 }}].cv_pattern.{{ lang }}.text" 
                                                                           value="{{ text }}"
                                                                           placeholder="e.g., CVCC, CV-CVC">
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-cv-pattern-language-btn ms-2 mt-4" 
                                                                        data-pron-index="{{ loop.index0 }}"
                                                                        title="Remove this language">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary add-cv-pattern-language-btn" 
                                            data-pron-index="{{ loop.index0 }}"
                                            title="Add CV pattern in another language">
                                        <i class="fas fa-plus"></i> Add Language
                                    </button>
                                    <div class="form-text small">Syllable structure pattern (Consonant-Vowel notation).</div>
                                </div>
                                
                                <!-- LIFT 0.13: Tone (Day 40) -->
                                <div class="mt-3 mb-2">
                                    <label class="form-label">
                                        Tone
                                        <i class="fas fa-info-circle ms-1 form-tooltip" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top"
                                           data-bs-html="true"
                                           title="<strong>About Tone:</strong><br>Tone information for tone languages (e.g., High, Low, Rising, Falling, or numeric notation like 35, 51)."></i>
                                    </label>
                                    <div class="multilingual-forms tone-forms" data-pron-index="{{ loop.index0 }}">
                                        {% if entry.pronunciation_tone %}
                                            {% for lang, text in entry.pronunciation_tone.items() %}
                                                <div class="language-form-group mb-2 border rounded p-2" data-lang="{{ lang }}">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <label class="form-label small">Language</label>
                                                            <select class="form-select form-select-sm language-selector" 
                                                                    name="pronunciations[{{ loop.index0 }}].tone.{{ lang }}.lang"
                                                                    data-field-name="pronunciations[{{ loop.index0 }}].tone.{{ lang }}">
                                                                <option value="">Select language</option>
                                                                {% for available_lang in available_languages %}
                                                                    <option value="{{ available_lang }}" {% if lang == available_lang %}selected{% endif %}>{{ available_lang }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-9">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <label class="form-label small">Tone</label>
                                                                    <input type="text" class="form-control form-control-sm tone-text" 
                                                                           name="pronunciations[{{ loop.index0 }}].tone.{{ lang }}.text" 
                                                                           value="{{ text }}"
                                                                           placeholder="e.g., High, 35, Rising">
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-tone-language-btn ms-2 mt-4" 
                                                                        data-pron-index="{{ loop.index0 }}"
                                                                        title="Remove this language">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary add-tone-language-btn" 
                                            data-pron-index="{{ loop.index0 }}"
                                            title="Add tone in another language">
                                        <i class="fas fa-plus"></i> Add Language
                                    </button>
                                    <div class="form-text small">Tone marking for tone languages.</div>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" 
                                           id="pron-default-{{ loop.index0 }}" name="pronunciations[{{ loop.index0 }}].is_default"
                                           {% if loop.index0 == 0 %}checked{% endif %}>
                                    <label class="form-check-label" for="pron-default-{{ loop.index0 }}">
                                        Default pronunciation
                                    </label>
                                </div>
                                
                                {% if loop.index0 > 0 %}
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                                            data-index="{{ loop.index0 }}" title="Remove pronunciation">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Fallback message if no pronunciations exist -->
                        {% if not entry.pronunciations %}
                        <div class="text-muted mb-3" id="no-pronunciations-message">
                            No pronunciations added yet. Click "Add Pronunciation" to get started.
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-primary" id="add-pronunciation-btn">
                        <i class="fas fa-plus"></i> Add Pronunciation
                    </button>
                </div>
            </div>
            
            <div class="card mb-4 variants-section">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-code-branch"></i> Variants
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Variants:</strong><br>Variants represent different forms, spellings, or morphological variations of the same lexical item. Examples include 'protestor' vs 'protester', 'Protestant ethic' vs 'Protestant work ethic', or inflected forms like plurals and past tense forms."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-variant-btn">
                            <i class="fas fa-plus"></i> Add Variant
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="variants-container">
                        <!-- Server-side rendered variant items -->
                        {% if variant_relations %}
                            {% for variant in variant_relations %}
                            <div class="variant-item card mb-3" data-variant-index="{{ loop.index0 }}" data-direction="{{ variant.direction or 'outgoing' }}">
                                <div class="card-header {% if variant.direction == 'incoming' %}bg-info{% else %}bg-success{% endif %} text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas {% if variant.direction == 'incoming' %}fa-arrow-left{% else %}fa-arrow-right{% endif %} me-2"></i>
                                            {% if variant.direction == 'incoming' %}
                                                Has Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% else %}
                                                Is a Variant: {{ variant.variant_type or 'Unknown Type' }}
                                            {% endif %}
                                        </h6>
                                        {% if variant.direction != 'incoming' %}
                                        <button type="button" class="btn btn-sm btn-light remove-variant-btn" 
                                                data-index="{{ loop.index0 }}" title="Remove variant">
                                            <i class="fas fa-trash text-danger"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    {% if variant.direction == 'incoming' %}
                                    <!-- Incoming: Other entries ARE variants of this entry (display only) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Entry that is a variant of this one</label>
                                            {% if variant.ref_display_text %}
                                            <div class="alert alert-light">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit this entry">
                                                        {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                    </a>
                                                </strong>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Entry Not Found: </strong>
                                                The entry ID "<code>{{ variant.ref }}</code>" could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect reference.</small>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-question-circle me-2"></i>
                                                <strong>No Entry Referenced</strong>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">
                                                Variant Type                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>Reverse Relationship:</strong><br>{% if variant.ref_display_text %}The entry '<strong>{{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}</strong>' is marked as a {{ variant.variant_type }} of this entry.{% elif variant.ref %}An entry with ID '{{ variant.ref }}' is marked as a {{ variant.variant_type }} of this entry, but the entry could not be found.{% else %}An unknown entry is marked as a {{ variant.variant_type }} of this entry.{% endif %} This relationship is defined in the other entry's data."></i>
                                            </label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-info fs-6">{{ variant.variant_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <!-- Outgoing: This entry IS a variant of another (editable) -->
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Target Entry</label>
                                            {% if variant.ref_display_text %}
                                            <!-- Show clickable link to target entry -->
                                            <div class="alert alert-light mb-2">
                                                <i class="fas fa-external-link-alt me-2"></i>
                                                <strong>This entry is a variant of: </strong>
                                                <a href="{{ url_for('main.edit_entry', entry_id=variant.ref) }}" 
                                                   class="text-decoration-none text-primary fw-bold"
                                                   title="Edit target entry">
                                                    {{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}
                                                </a>
                                            </div>
                                            {% elif variant.ref %}
                                            <!-- Show error marker for missing target entry -->
                                            <div class="alert alert-danger mb-2">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Target Entry Not Found: </strong>
                                                The referenced entry could not be found in the dictionary.
                                                <br><small>This may indicate a missing entry or an incorrect reference.</small>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}].ref"
                                                   value="{{ variant.ref or '' }}">
                                            <!-- Hidden technical fields -->
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}].type"
                                                   value="{{ variant.type or '_component-lexeme' }}">
                                            <input type="hidden" 
                                                   name="variant_relations[{{ loop.index0 }}].order"
                                                   value="{{ variant.order or loop.index0 }}">
                                            
                                            <!-- Search interface for adding/changing variant targets -->
                                            <div class="input-group">
                                                <input type="text" class="form-control variant-search-input" 
                                                       placeholder="Search for entry to create variant relationship with..."
                                                       data-variant-index="{{ loop.index0 }}">
                                                <button type="button" class="btn btn-outline-secondary variant-search-btn" 
                                                        data-variant-index="{{ loop.index0 }}">
                                                    <i class="fas fa-search"></i> Search
                                                </button>
                                            </div>
                                            <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                            <div class="search-results mt-2" id="variant-search-results-{{ loop.index0 }}" style="display: none;"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Variant Type</label>
                                            <select class="form-control" 
                                                    name="variant_relations[{{ loop.index0 }}].variant_type" required>
                                                <option value="">Select variant type</option>
                                                <option value="Spelling Variant" {% if variant.variant_type == 'Spelling Variant' %}selected{% endif %}>Spelling Variant</option>
                                                <option value="Dialectal Variant" {% if variant.variant_type == 'Dialectal Variant' %}selected{% endif %}>Dialectal Variant</option>
                                                <option value="Unspecified Variant" {% if variant.variant_type == 'Unspecified Variant' %}selected{% endif %}>Unspecified Variant</option>
                                                <option value="Stopie najwyszy" {% if variant.variant_type == 'Stopie najwyszy' %}selected{% endif %}>Stopie najwyszy</option>
                                                <option value="Plural Form" {% if variant.variant_type == 'Plural Form' %}selected{% endif %}>Plural Form</option>
                                                <option value="Past Tense" {% if variant.variant_type == 'Past Tense' %}selected{% endif %}>Past Tense</option>
                                            </select>
                                            <div class="form-text">Type of variant relationship</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">
                                                Status
                                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                                   data-bs-toggle="tooltip" 
                                                   data-bs-placement="top"
                                                   data-bs-html="true"
                                                   title="<strong>Variant Relationship:</strong><br>This entry is a variant of {% if variant.ref_display_text %}'<strong>{{ variant.ref_display_text or variant.ref_lexical_unit or variant.ref }}</strong>'.{% elif variant.ref %}a target entry that could not be found.{% else %}an unspecified entry.{% endif %}"></i>
                                            </label>
                                            <div class="mt-2">
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-check-circle me-1"></i>Active Variant
                                                </span>
                                                <div class="form-text">This variant will be saved to the dictionary</div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Empty state when no variants exist -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-code-branch fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Variant Relations</h5>
                            <p class="text-muted">This entry does not have any variant relations defined.</p>
                            <p class="text-muted">
                                <strong>What are variants?</strong> Variants are different forms or spellings of the same lexical item, 
                                such as "protestor" vs "protester", or "Protestant ethic" vs "Protestant work ethic".
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Component Relations Section -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group"></i> Complex Form Components
                        <i class="fas fa-info-circle ms-2 form-tooltip" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           data-bs-html="true"
                           title="<strong>About Complex Forms:</strong><br>Complex forms are entries like compounds ('basketball'), phrases ('Protestant work ethic'), or other multi-word expressions that function as single lexical units. They are composed of multiple lexical components."></i>
                    </h5>
                </div>
                <div class="card-body">
                    {% if component_relations and component_relations|length > 0 %}
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>This entry is a complex form</strong> composed of the following main entries:
                        </div>
                        
                        {% for component in component_relations %}
                        <div class="component-item card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-puzzle-piece me-2"></i>
                                    Component {{ loop.index }} ({{ component.complex_form_type }})
                                    {% if component.is_primary %}
                                    <span class="badge bg-success ms-2">Primary</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if component.ref_display_text %}
                                <!-- Show clickable link to main entry -->
                                <div class="alert alert-primary mb-0">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    <strong>Main Entry: </strong>
                                    <a href="{{ url_for('main.edit_entry', entry_id=component.ref) }}" 
                                       class="text-decoration-none text-primary fw-bold"
                                       title="Edit main entry">
                                        {{ component.ref_display_text|safe }}
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        <strong>Type:</strong> {{ component.complex_form_type }} 
                                        | <strong>Order:</strong> {{ component.order if component.order is not none else 'N/A' }}
                                    </small>
                                </div>
                                {% elif component.ref %}
                                <!-- Show error marker for missing main entry -->
                                <div class="alert alert-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Main Entry Not Found: </strong>
                                    The referenced main entry ID "<code>{{ component.ref }}</code>" could not be found in the dictionary.
                                    <br><small>This may indicate a missing entry or an incorrect ID.</small>
                                </div>
                                {% else %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-question-circle me-2"></i>
                                    <strong>No Main Entry Referenced</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                    {% else %}
                        <!-- Empty state when no component relations exist -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-puzzle-piece fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Complex Form Components</h5>                            
                        </div>
                    {% endif %}
                    
                    <!-- Add new component interface -->
                    <div class="mt-3 border-top pt-3">
                        <h6 class="mb-3">
                            <i class="fas fa-plus-circle me-2"></i>Add Component
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Component Type</label>
                                <select class="form-select component-type-select" id="new-component-type">
                                    <option value="">Select type...</option>
                                    <option value="compound">Compound</option>
                                    <option value="phrase">Phrase</option>
                                    <option value="idiom">Idiom</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Search for Main Entry</label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control component-search-input" 
                                           id="component-search-input"
                                           placeholder="Search for entry..."
                                           autocomplete="off">
                                    <button type="button" 
                                            class="btn btn-outline-secondary component-search-btn" 
                                            id="component-search-btn">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                                <div class="form-text">Search by headword to find component entry</div>
                                
                                <!-- Search results dropdown -->
                                <div class="component-search-results" 
                                     id="component-search-results"
                                     style="display: none; position: relative; z-index: 1000;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected components (to be added) -->
                        <div id="new-components-list" class="mt-3" style="display: none;">
                            <h6 class="text-success">
                                <i class="fas fa-check-circle me-2"></i>Components to Add:
                            </h6>
                            <div id="new-components-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4 relations-section">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-link"></i> Relations
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Relations:</strong><br>Relations represent semantic connections between different lexical entries. Examples include synonyms (words with similar meanings), antonyms (opposite meanings), hyponyms (specific instances of a general term), and hypernyms (general terms for specific instances). These are distinct from variants that represent different forms of the same lexical item."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-relation-btn">
                            <i class="fas fa-plus"></i> Add Relation
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="relations-container">
                        <!-- Server-side rendered relation items -->
                        {% if entry.relations %}
                            {% set filtered_relations = [] %}
                            {% for relation in entry.relations %}
                                {# Filter out _component-lexeme relations with variant-type or complex-form-type traits #}
                                {% if not (relation.type == '_component-lexeme' and relation.traits and ('variant-type' in relation.traits or 'complex-form-type' in relation.traits)) %}
                                    {% set _ = filtered_relations.append(relation) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if filtered_relations %}
                                {% for relation in filtered_relations %}
                                <div class="relation-item card mb-3" data-relation-index="{{ loop.index0 }}">
                                    <div class="card-header bg-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-link me-2"></i>
                                                Relation: {{ relation.type or 'Unknown Type' }}
                                            </h6>
                                            <button type="button" class="btn btn-sm btn-light remove-relation-btn" 
                                                    data-index="{{ loop.index0 }}" title="Remove relation">
                                                <i class="fas fa-trash text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold">
                                                    Relation Type
                                                    <i class="fas fa-info-circle ms-1 form-tooltip" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top"
                                                       data-bs-html="true"
                                                       title="<strong>Semantic Relationship:</strong><br>This entry has a '{{ relation.type }}' relationship with {% if relation.ref_display_text %}'<strong>{{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}</strong>'.{% else %}the target entry.{% endif %}"></i>
                                                </label>
                                                <select class="form-control relation-type-select" 
                                                        name="relations[{{ loop.index0 }}].type" 
                                                        data-range-id="lexical-relation"
                                                        data-hierarchical="true"
                                                        data-searchable="true"
                                                        required>
                                                    <option value="">Select type</option>
                                                    <!-- Options will be populated dynamically from LIFT ranges -->
                                                </select>
                                                <div class="form-text">Type of semantic relation</div>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label fw-bold">Target Entry</label>
                                                {% if relation.ref_display_text %}
                                                <!-- Show clickable link to target entry -->
                                                <div class="alert alert-light mb-2">
                                                    <i class="fas fa-external-link-alt me-2"></i>
                                                    <strong>Related to: </strong>
                                                    <a href="{{ url_for('main.edit_entry', entry_id=relation.ref) }}" 
                                                       class="text-decoration-none text-primary fw-bold"
                                                       title="Edit target entry">
                                                        {{ relation.ref_display_text or relation.ref_lexical_unit or relation.ref }}
                                                    </a>
                                                </div>
                                                {% endif %}
                                                
                                                <!-- Hidden input field for form submission (NO raw ID visible to user) -->
                                                <input type="hidden" 
                                                       name="relations[{{ loop.index0 }}].ref"
                                                       value="{{ relation.ref or '' }}">
                                                
                                                <!-- Search interface for adding/changing relations -->
                                                <div class="input-group">
                                                    <input type="text" class="form-control relation-search-input" 
                                                           placeholder="Search for entry to relate to..."
                                                           data-relation-index="{{ loop.index0 }}">
                                                    <button type="button" class="btn btn-outline-secondary relation-search-btn" 
                                                            data-relation-index="{{ loop.index0 }}">
                                                        <i class="fas fa-search"></i> Search
                                                    </button>
                                                </div>
                                                <div class="form-text">Search for entries by headword or definition - no raw IDs needed</div>
                                                <div class="search-results mt-2" id="search-results-{{ loop.index0 }}" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <!-- Empty state when no non-variant relations exist -->
                            <div class="empty-state text-center py-4">
                                <i class="fas fa-link fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Semantic Relations</h5>
                            </div>
                            {% endif %}
                        {% else %}
                        <!-- Empty state when no relations exist at all -->
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-link fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Semantic Relations</h5>
                        </div>
                        {% endif %}
                    </div>
                    
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Etymology
                            <i class="fas fa-info-circle ms-2 form-tooltip" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-html="true"
                               title="<strong>About Etymology:</strong><br>Etymology traces the historical origin and development of words. This includes information about source languages, etymological forms, meanings, and the type of linguistic change (inheritance, borrowing, derivation, etc.)."></i>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-etymology-btn">
                            <i class="fas fa-plus"></i> Add Etymology
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="etymology-container">
                        <!-- Etymology forms will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- LIFT 0.13: Literal Meaning (Entry-Level Custom Field - Day 28) -->
            <!-- MOVED TO SENSE LEVEL - SEE LINE ~1240 -->
            
        </div>
        
        <div class="col-md-8">
            <div class="card senses-section">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Senses</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-sense-btn">
                            <i class="fas fa-plus"></i> Add Sense
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <div id="senses-container">
                        {% if entry.senses %}
                            {% for sense in entry.senses %}
                                {% set sense_index = loop.index0 %}
                                <div class="sense-item card mb-4" data-sense-index="{{ sense_index }}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="drag-handle me-2" title="Drag to reorder" style="cursor: grab;">
                                        <i class="fas fa-grip-vertical text-muted"></i>
                                    </div>
                                    <span>Sense {{ loop.index }}</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-secondary move-sense-up" title="Move Up"></button>
                                    <button type="button" class="btn btn-sm btn-secondary move-sense-down" title="Move Down"></button>                                                                            
                                    {% if entry.senses|length > 1 %}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                                                data-index="{{ sense_index }}">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    {% endif %}
                                </div>
                                </div>
                                    <div class="card-body">
                                        <!-- Hidden field for sense ID -->
                                        <input type="hidden" name="senses[{{ sense_index }}].id" value="{{ sense.id }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Definition <span class="text-danger">*</span></label>
                                            <div class="multilingual-forms definition-forms">
                                                {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                {% set data_langs = sense.definitions.keys()|list %}
                                                {% set all_langs = (project_lang_codes + data_langs)|unique %}
                                                {% for lang in all_langs %}
                                                    {# Handle both flat LIFT format {lang: text} and nested form format {lang: {text: "..."}} #}
                                                    {% if lang in sense.definitions %}
                                                        {% set lang_value = sense.definitions[lang] %}
                                                        {% if lang_value is mapping and 'text' in lang_value %}
                                                            {% set text = lang_value['text'] %}
                                                        {% elif lang_value is string %}
                                                            {% set text = lang_value %}
                                                        {% else %}
                                                            {% set text = '' %}
                                                        {% endif %}
                                                    {% else %}
                                                        {% set text = '' %}
                                                    {% endif %}
                                                    <div class="mb-3 language-form" data-language="{{ lang }}">
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <label class="form-label">Language</label>
                                                                <select class="form-select language-select"
                                                                        name="senses[{{ sense_index }}].definition.{{ lang }}.lang"
                                                                        data-field-name="senses[{{ sense_index }}].definition.{{ lang }}">
                                                                    {% if lang not in project_lang_codes %}
                                                                        <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                                    {% endif %}
                                                                    {% for code, label in project_languages %}
                                                                        <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                            <div class="col-md-9">
                                                                <label class="form-label">Definition Text</label>
                                                                <textarea class="form-control definition-text" 
                                                                          name="senses[{{ sense_index }}].definition.{{ lang }}.text" 
                                                                          rows="2" 
                                                                          {% if loop.first %}required{% endif %}
                                                                          placeholder="Enter definition in {{ lang }}">{{ text }}</textarea>
                                                            </div>
                                                            <div class="col-md-1 d-flex align-items-end">
                                                                {% if not loop.first %}
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-definition-language-btn" 
                                                                        title="Remove language">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add another language">
                                                    <i class="fas fa-plus"></i> Add Language
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Gloss</label>
                                            <div class="multilingual-forms gloss-forms">
                                                {% for lang, gloss_text in sense.glosses.items() %}
                                                <div class="mb-3 language-form" data-language="{{ lang }}">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Language</label>
                                                            <select class="form-select language-select"
                                                                    name="senses[{{ sense_index }}].gloss.{{ lang }}.lang"
                                                                    data-field-name="senses[{{ sense_index }}].gloss.{{ lang }}">
                                                                {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                                {% if lang not in project_lang_codes %}
                                                                    <option value="{{ lang }}" selected>{{ lang }} (original)</option>
                                                                {% endif %}
                                                                {% for code, label in project_languages %}
                                                                    <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ label|safe }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <label class="form-label">Gloss Text</label>
                                                            <input type="text" class="form-control gloss-text" 
                                                                   name="senses[{{ sense_index }}].gloss.{{ lang }}.text" 
                                                                   value="{{ gloss_text }}"
                                                                   placeholder="Enter gloss in {{ lang }}">
                                                        </div>
                                                        <div class="col-md-1 d-flex align-items-end">
                                                            {% if not loop.first %}
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-gloss-language-btn" 
                                                                    title="Remove language">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                    {% endfor %}
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                                                        data-sense-index="{{ sense_index }}"
                                                        title="Add another language">
                                                    <i class="fas fa-plus"></i> Add Language
                                                </button>
                                            </div>
                                            <div class="form-text">A short equivalent in another language.</div>
                                        </div>
                                        
                        <div class="mb-3">
                            <label for="part-of-speech" class="form-label">Part of Speech</label>
                            <select class="form-select dynamic-grammatical-info" name="senses[{{ loop.index0 }}].grammatical_info"
                                    data-selected="{{ sense.grammatical_info }}"
                                    data-range-id="grammatical-info">
                                <option value="">Select part of speech</option>
                            </select>
                            <div class="form-text">Grammatical category for this sense.</div>
                        </div>

                        <!-- LIFT Ranges: Academic Domain (sense-level) -->
                        <div class="mb-3">
                            <label class="form-label">Academic Domain</label>
                            <select class="form-select dynamic-lift-range" name="senses[{{ loop.index0 }}].academic_domain"
                                    data-range-id="academic-domain"
                                    data-selected="{{ sense.academic_domain }}"
                                    data-hierarchical="true"
                                    data-searchable="true">
                                <option value="">Select academic domain</option>
                            </select>
                            <div class="form-text">Academic or disciplinary domain this sense belongs to.</div>
                        </div>
                        
                        <!-- LIFT Ranges: Semantic Domain (sense-level) -->
                        <div class="mb-3">
                            <label class="form-label">Semantic Domain</label>
                            <select class="form-select dynamic-lift-range" 
                                    name="senses[{{ loop.index0 }}].domain_type" 
                                    data-range-id="semantic-domain-ddp4" 
                                    data-hierarchical="true" 
                                    data-searchable="true"
                                    data-selected="{{ sense.domain_type|join(';') if sense.domain_type else '' }}"
                                    multiple>
                                <option value="">Select semantic domain(s)</option>
                            </select>
                            <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
                        </div>
                        
                        <!-- LIFT Ranges: Usage Type (sense-level) -->
                        <div class="mb-3">
                            <label class="form-label">Usage Type</label>
                            <select class="form-select dynamic-lift-range" 
                                    name="senses[{{ loop.index0 }}].usage_type" 
                                    data-range-id="usage-type"
                                    data-hierarchical="true"
                                    data-searchable="true"
                                    data-selected="{{ sense.usage_type|join(';') if sense.usage_type else '' }}"
                                    multiple>
                                <option value="">Select usage type(s)</option>
                            </select>
                            <div class="form-text">Usage classification for this sense (can select multiple).</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sense Note</label>
                            <textarea class="form-control" name="senses[{{ loop.index0 }}].note" 
                                      rows="2">{{ sense.note }}</textarea>
                        </div>

                        <!-- LIFT 0.13: Exemplar (Sense-Level Custom Field - Day 28) -->
                        <div class="mb-3">
                            <label class="form-label">
                                Exemplar
                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>About Exemplar:</strong><br>Shows the specific inflected form that this sense applies to. Particularly useful when different inflections of a headword have distinct meanings (common in Philippine/Austronesian languages). For example, a plural form might be used idiomatically but doesn't warrant a separate subentry or variant. This is 'vernacular content at the beginning of a sense' that clarifies which inflection the definition describes."></i>
                            </label>
                            <div class="multilingual-forms exemplar-forms">
                                {% if sense.exemplar %}
                                    {% for lang, text in sense.exemplar.items() %}
                                        <div class="language-form-group mb-3 border rounded p-3" data-lang="{{ lang }}">
                                            <div class="row align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-selector" 
                                                            name="senses[{{ sense_index }}].exemplar.{{ lang }}.lang"
                                                            data-field-name="senses[{{ sense_index }}].exemplar.{{ lang }}">
                                                        <option value="">Select language</option>
                                                        {% for available_lang in available_languages %}
                                                            <option value="{{ available_lang }}" {% if lang == available_lang %}selected{% endif %}>{{ available_lang }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-9">
                                                    <div class="d-flex align-items-start">
                                                        <div class="flex-grow-1">
                                                            <label class="form-label">Exemplar Text</label>
                                                            <textarea class="form-control exemplar-text" 
                                                                      name="senses[{{ sense_index }}].exemplar.{{ lang }}.text" 
                                                                      rows="2"
                                                                      placeholder="Enter exemplar form in {{ lang }}">{{ text }}</textarea>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-exemplar-language-btn ms-2 mt-4" 
                                                                data-sense-index="{{ sense_index }}"
                                                                title="Remove this language">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary add-exemplar-language-btn" 
                                        data-sense-index="{{ sense_index }}"
                                        title="Add another language">
                                    <i class="fas fa-plus"></i> Add Language
                                </button>
                            </div>
                            <div class="form-text">Specific inflected form this sense applies to (e.g., plural form with distinct meaning).</div>
                        </div>

                        <!-- LIFT 0.13: Scientific Name (Sense-Level Custom Field - Day 28) -->
                        <div class="mb-3">
                            <label class="form-label">
                                Scientific Name
                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>About Scientific Name:</strong><br>The scientific (Latin/binomial) name for biological terms. For example, the scientific name for 'sunflower' is 'Helianthus annuus'."></i>
                            </label>
                            <div class="multilingual-forms scientific-name-forms">
                                {% if sense.scientific_name %}
                                    {% for lang, text in sense.scientific_name.items() %}
                                        <div class="language-form-group mb-3 border rounded p-3" data-lang="{{ lang }}">
                                            <div class="row align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-selector" 
                                                            name="senses[{{ sense_index }}].scientific_name.{{ lang }}.lang"
                                                            data-field-name="senses[{{ sense_index }}].scientific_name.{{ lang }}">
                                                        <option value="">Select language</option>
                                                        {% for available_lang in available_languages %}
                                                            <option value="{{ available_lang }}" {% if lang == available_lang %}selected{% endif %}>{{ available_lang }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-9">
                                                    <div class="d-flex align-items-start">
                                                        <div class="flex-grow-1">
                                                            <label class="form-label">Scientific Name</label>
                                                            <textarea class="form-control scientific-name-text" 
                                                                      name="senses[{{ sense_index }}].scientific_name.{{ lang }}.text" 
                                                                      rows="2"
                                                                      placeholder="Enter scientific name in {{ lang }}">{{ text }}</textarea>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-scientific-name-language-btn ms-2 mt-4" 
                                                                data-sense-index="{{ sense_index }}"
                                                                title="Remove this language">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary add-scientific-name-language-btn" 
                                        data-sense-index="{{ sense_index }}"
                                        title="Add another language">
                                    <i class="fas fa-plus"></i> Add Language
                                </button>
                            </div>
                            <div class="form-text">Scientific/Latin name for biological or taxonomic terms.</div>
                        </div>

                        <!-- LIFT 0.13: Literal Meaning (Sense-Level Custom Field - Day 28 - MOVED FROM ENTRY LEVEL) -->
                        <div class="mb-3">
                            <label class="form-label">
                                Literal Meaning
                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>About Literal Meaning:</strong><br>The literal meaning of compounds or idioms. For example, 'sunflower' literally means 'sun-flower', or 'kick the bucket' literally means 'strike a pail with your foot'."></i>
                            </label>
                            <div class="multilingual-forms literal-meaning-forms">
                                {% if sense.literal_meaning %}
                                    {% for lang, text in sense.literal_meaning.items() %}
                                        <div class="language-form-group mb-3 border rounded p-3" data-lang="{{ lang }}">
                                            <div class="row align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label">Language</label>
                                                    <select class="form-select language-selector" 
                                                            name="senses[{{ sense_index }}].literal_meaning.{{ lang }}.lang"
                                                            data-field-name="senses[{{ sense_index }}].literal_meaning.{{ lang }}">
                                                        <option value="">Select language</option>
                                                        {% for available_lang in available_languages %}
                                                            <option value="{{ available_lang }}" {% if lang == available_lang %}selected{% endif %}>{{ available_lang }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-9">
                                                    <div class="d-flex align-items-start">
                                                        <div class="flex-grow-1">
                                                            <label class="form-label">Literal Meaning Text</label>
                                                            <textarea class="form-control literal-meaning-text" 
                                                                      name="senses[{{ sense_index }}].literal_meaning.{{ lang }}.text" 
                                                                      rows="2"
                                                                      placeholder="Enter literal meaning in {{ lang }}">{{ text }}</textarea>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-literal-meaning-language-btn ms-2 mt-4" 
                                                                data-sense-index="{{ sense_index }}"
                                                                title="Remove this language">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary add-literal-meaning-language-btn" 
                                        data-sense-index="{{ sense_index }}"
                                        title="Add another language">
                                    <i class="fas fa-plus"></i> Add Language
                                </button>
                            </div>
                            <div class="form-text">The literal/compositional meaning of idioms or compound words.</div>
                        </div>

                        <!-- LIFT 0.13: Illustrations (Day 33-34) -->
                        <div class="mb-3">
                            <label class="form-label">
                                Illustrations
                                <i class="fas fa-info-circle ms-1 form-tooltip" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-html="true"
                                   title="<strong>About Illustrations:</strong><br>Add images to help illustrate this sense. You can provide image paths or URLs, and add multilingual labels/captions for each image."></i>
                            </label>
                            <div class="illustrations-container" data-sense-index="{{ sense_index }}">
                                {% if sense.illustrations %}
                                    {% for illustration in sense.illustrations %}
                                        <div class="illustration-item card mb-3" data-illustration-index="{{ loop.index0 }}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0"><i class="fas fa-image"></i> Illustration {{ loop.index }}</h6>
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-illustration-btn"
                                                            data-sense-index="{{ sense_index }}" 
                                                            data-illustration-index="{{ loop.index0 }}"
                                                            title="Remove illustration">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Image Path/URL -->
                                                <div class="mb-3">
                                                    <label class="form-label">Image Path/URL</label>
                                                    <div class="input-group">
                                                        <input type="text" 
                                                               class="form-control illustration-href" 
                                                               name="senses[{{ sense_index }}].illustrations[{{ loop.index0 }}].href" 
                                                               value="{{ illustration.href }}"
                                                               placeholder="images/photo.jpg or https://example.com/image.jpg"
                                                               readonly>
                                                        <button class="btn btn-outline-secondary upload-illustration-btn" 
                                                                type="button" 
                                                                data-sense-index="{{ sense_index }}"
                                                                data-illustration-index="{{ loop.index0 }}"
                                                                title="Upload image file">
                                                            <i class="fas fa-upload"></i> Upload Image
                                                        </button>
                                                    </div>
                                                    <div class="form-text">Relative path (e.g., images/photo.jpg) or absolute URL</div>
                                                </div>
                                                
                                                <!-- Image Preview -->
                                                {% if illustration.href %}
                                                <div class="mb-3 image-preview-container">
                                                    <img src="{{ illustration.href if illustration.href.startswith('http') else url_for('static', filename=illustration.href) }}" 
                                                         class="img-thumbnail illustration-preview" 
                                                         style="max-width: 300px; max-height: 200px;"
                                                         alt="Illustration preview"
                                                         onerror="this.style.display='none';">
                                                </div>
                                                {% endif %}
                                                
                                                <!-- Multilingual Labels -->
                                                <div class="illustration-labels">
                                                    <label class="form-label">Labels/Captions (Multilingual)</label>
                                                    <div class="multilingual-forms illustration-label-forms">
                                                        {% if illustration.label %}
                                                            {% for lang, text in illustration.label.items() %}
                                                                <div class="language-form-group mb-2 border rounded p-2" data-lang="{{ lang }}">
                                                                    <div class="row align-items-center">
                                                                        <div class="col-md-3">
                                                                            <span class="badge bg-secondary">{{ lang }}</span>
                                                                        </div>
                                                                        <div class="col-md-9">
                                                                            <div class="d-flex align-items-center">
                                                                                <input type="text" 
                                                                                       class="form-control form-control-sm illustration-label-text" 
                                                                                       name="senses[{{ sense_index }}].illustrations[{{ loop.index0 }}].label.{{ lang }}" 
                                                                                       value="{{ text }}"
                                                                                       placeholder="Caption in {{ lang }}">
                                                                                <button type="button" 
                                                                                        class="btn btn-sm btn-outline-danger remove-illustration-label-language-btn ms-2" 
                                                                                        data-sense-index="{{ sense_index }}"
                                                                                        data-illustration-index="{{ loop.index0 }}"
                                                                                        title="Remove this language">
                                                                                    <i class="fas fa-times"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </div>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-primary add-illustration-label-language-btn mt-1" 
                                                            data-sense-index="{{ sense_index }}"
                                                            data-illustration-index="{{ loop.index0 }}"
                                                            title="Add caption in another language">
                                                        <i class="fas fa-plus"></i> Add Caption Language
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="no-illustrations text-center text-muted py-3 border rounded">
                                        <p class="mb-2"><i class="fas fa-image fa-2x"></i></p>
                                        <p>No illustrations added yet</p>
                                    </div>
                                {% endif %}
                            </div>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-primary add-illustration-btn mt-2" 
                                    data-sense-index="{{ sense_index }}"
                                    title="Add an illustration">
                                <i class="fas fa-plus"></i> Add Illustration
                            </button>
                            <div class="form-text">Add images with optional multilingual captions to illustrate this sense.</div>
                        </div>

                                        <div class="examples-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="{{ loop.index0 }}">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                            
                                            <div class="examples-container">
                                                {% if sense.examples %}
                                                {% for example in sense.examples %}
                                                    <div class="example-item card mb-3" data-example-index="{{ loop.index0 }}">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <h6 class="mb-0">Example {{ loop.index }}</h6>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn"
                                                                        data-sense-index="0" data-example-index="{{ loop.index0 }}">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Example Sentence</label>
                                                                <textarea class="form-control" name="senses[{{ sense_index }}].examples[{{ loop.index0 }}].sentence"
                                                                          rows="2">{{ example.sentence }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Translation</label>
                                                                <textarea class="form-control" name="senses[{{ sense_index }}].examples[{{ loop.index0 }}].translation"
                                                                          rows="2">{{ example.translation }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Translation Type
                                                                    <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                                                                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                           title="Specify the type of translation: 'literal' for word-for-word translation, 'free' for natural/idiomatic translation, or other types as defined in your project."></i>
                                                                    </span>
                                                                </label>
                                                                <select class="form-select dynamic-lift-range" 
                                                                        name="senses[{{ sense_index }}].examples[{{ loop.index0 }}].translation_type"
                                                                        data-range-id="translation-type"
                                                                        data-hierarchical="false"
                                                                        data-searchable="true">
                                                                    <option value="">Select translation type</option>
                                                                    <option value="literal" {% if example.translation_type == 'literal' %}selected{% endif %}>Literal</option>
                                                                    <option value="free" {% if example.translation_type == 'free' %}selected{% endif %}>Free/Idiomatic</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                {% else %}
                                                    <div class="no-examples text-center text-muted py-3 border rounded">
                                                        <p>No examples added yet</p>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                                data-sense-index="{{ loop.index0 }}">
                                                            <i class="fas fa-plus"></i> Add Example
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- LIFT 0.13: Sense Relations Section (Day 42) -->
                                        <div class="sense-relations-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6>
                                                    <i class="fas fa-project-diagram"></i> Sense Relations
                                                    <i class="fas fa-info-circle ms-2 form-tooltip" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top"
                                                       data-bs-html="true"
                                                       title="<strong>About Sense Relations:</strong><br>Sense-level semantic relationships link this specific meaning to other senses. Examples: synonyms (similar meanings), antonyms (opposite meanings), hyponyms (more specific), hypernyms (more general). These are distinct from entry-level relations which link entire words."></i>
                                                </h6>
                                                <button type="button" class="btn btn-sm btn-outline-warning add-sense-relation-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add a semantic relation for this sense">
                                                    <i class="fas fa-plus"></i> Add Sense Relation
                                                </button>
                                            </div>
                                            
                                            <div class="sense-relations-container ms-3" data-sense-index="{{ loop.index0 }}">
                                                {% if sense.relations %}
                                                    {% for relation in sense.relations %}
                                                        <div class="sense-relation-item card mb-3 border-warning" data-relation-index="{{ loop.index0 }}">
                                                            <div class="card-header bg-warning bg-opacity-10">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span><i class="fas fa-link"></i> Relation: {{ relation.get('type', relation['type'] if relation['type'] else 'unspecified') if relation is mapping else (relation.type or 'unspecified') }}</span>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-sense-relation-btn"
                                                                            data-sense-index="{{ sense_index }}" data-relation-index="{{ loop.index0 }}">
                                                                        <i class="fas fa-trash"></i> Remove
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    <div class="col-md-4">
                                                                        <label class="form-label">Relation Type</label>
                                                                        <select class="form-control sense-relation-type-select" 
                                                                                name="senses[{{ sense_index }}].relations[{{ loop.index0 }}].type"
                                                                                required>
                                                                            <option value="">Select type</option>
                                                                            {% set rel_type = relation.get('type', '') if relation is mapping else (relation.type or '') %}
                                                                            {% if ranges and ranges.get('lexical-relation') and ranges['lexical-relation'].get('values') %}
                                                                                {% for range_value in ranges['lexical-relation']['values'] %}
                                                                                    <option value="{{ range_value.id }}" {% if rel_type == range_value.id %}selected{% endif %}>
                                                                                        {{ range_value.description.get('pl', range_value.description.get('en', range_value.id)) }}
                                                                                        {% if range_value.description.get('en') and range_value.description.get('pl') and range_value.description.get('en') != range_value.description.get('pl') %}
                                                                                            ({{ range_value.description.get('en') }})
                                                                                        {% endif %}
                                                                                    </option>
                                                                                {% endfor %}
                                                                            {% else %}
                                                                                <!-- Fallback if ranges not loaded -->
                                                                                <option value="synonim" {% if rel_type == 'synonim' %}selected{% endif %}>Synonim (Synonym)</option>
                                                                                <option value="antonim" {% if rel_type == 'antonim' %}selected{% endif %}>Antonim (Antonym)</option>
                                                                                <option value="Part" {% if rel_type == 'Part' %}selected{% endif %}>Part (Part/Whole)</option>
                                                                                <option value="Przypadek" {% if rel_type == 'Przypadek' %}selected{% endif %}>Przypadek (Generic/Specific)</option>
                                                                            {% endif %}
                                                                        </select>
                                                                        <div class="form-text">Type of semantic relation</div>
                                                                    </div>
                                                                    <div class="col-md-8">
                                                                        <label class="form-label">Target Sense</label>
                                                                        {% if relation.get('ref_display_text') or relation.get('ref_gloss') %}
                                                                        <!-- Show resolved target sense information -->
                                                                        <div class="alert alert-light mb-2">
                                                                            <i class="fas fa-project-diagram me-2"></i>
                                                                            <strong>Related to: </strong>
                                                                            <span class="fw-bold text-dark">
                                                                                {{ relation.ref_display_text or 'Unknown' }}
                                                                            </span>
                                                                            {% if relation.get('ref_gloss') %}
                                                                            <span class="text-muted">  {{ relation.ref_gloss }}</span>
                                                                            {% endif %}
                                                                        </div>
                                                                        {% else %}
                                                                        <!-- Show warning if relation exists but not resolved -->
                                                                        <div class="alert alert-warning mb-2">
                                                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                                                            <strong>Target not found: </strong>
                                                                            <code>{{ relation.ref }}</code>
                                                                        </div>
                                                                        {% endif %}
                                                                        
                                                                        <!-- Hidden input for form submission -->
                                                                        <input type="hidden" 
                                                                               class="sense-relation-ref-hidden"
                                                                               name="senses[{{ sense_index }}].relations[{{ loop.index0 }}].ref"
                                                                               value="{{ relation.ref or '' }}">
                                                                        
                                                                        <!-- Search interface for changing target -->
                                                                        <div class="input-group">
                                                                            <input type="text" 
                                                                                   class="form-control sense-relation-search-input" 
                                                                                   placeholder="Search to change target..."
                                                                                   data-sense-index="{{ sense_index }}"
                                                                                   data-relation-index="{{ loop.index0 }}"
                                                                                   autocomplete="off">
                                                                            <button type="button" 
                                                                                    class="btn btn-outline-secondary sense-relation-search-btn" 
                                                                                    data-sense-index="{{ sense_index }}"
                                                                                    data-relation-index="{{ loop.index0 }}">
                                                                                <i class="fas fa-search"></i> Search
                                                                            </button>
                                                                        </div>
                                                                        <div class="form-text">Search by headword to change target entry/sense</div>
                                                                        
                                                                        <!-- Search results dropdown -->
                                                                        <div class="sense-relation-search-results" 
                                                                             id="sense-search-results-{{ sense_index }}-{{ loop.index0 }}"
                                                                             style="display: none; position: relative; z-index: 1000;">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="no-sense-relations text-center text-muted py-2 border border-warning border-opacity-25 rounded">
                                                        <p class="mb-2"><small>No sense relations yet. Add relations to link this sense to related meanings.</small></p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Subsenses Section (LIFT 0.13 - Day 22) -->
                                        <div class="subsenses-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-sitemap"></i> Subsenses</h6>
                                                <button type="button" class="btn btn-sm btn-outline-success add-subsense-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add a more specific meaning under this sense">
                                                    <i class="fas fa-plus"></i> Add Subsense
                                                </button>
                                            </div>
                                            
                                            <div class="subsenses-container ms-3" data-sense-index="{{ loop.index0 }}">
                                                {% if sense.subsenses %}
                                                    {% for subsense in sense.subsenses %}
                                                        <!-- Subsense cards will be rendered here -->
                                                        <div class="subsense-item card mb-3 border-success" data-subsense-index="{{ loop.index0 }}">
                                                            <div class="card-header bg-success bg-opacity-10">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span><i class="fas fa-level-down-alt"></i> Subsense {{ loop.index }}</span>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-subsense-btn"
                                                                            data-sense-index="{{ sense_index }}" data-subsense-index="{{ loop.index0 }}">
                                                                        <i class="fas fa-trash"></i> Remove
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="card-body">
                                                                <input type="hidden" name="senses[{{ sense_index }}].subsenses[{{ loop.index0 }}].id" value="{{ subsense.id }}">
                                                                
                                                                <!-- Subsense Definition -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Definition</label>
                                                                    <textarea class="form-control" 
                                                                              name="senses[{{ sense_index }}].subsenses[{{ loop.index0 }}].definition" 
                                                                              rows="2">{{ subsense.definition }}</textarea>
                                                                </div>
                                                                
                                                                <!-- Subsense Gloss -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Gloss</label>
                                                                    <input type="text" class="form-control" 
                                                                           name="senses[{{ sense_index }}].subsenses[{{ loop.index0 }}].gloss" 
                                                                           value="{{ subsense.gloss }}">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="no-subsenses text-center text-muted py-2 border border-success border-opacity-25 rounded">
                                                        <p class="mb-2"><small>No subsenses yet. Add subsenses to create more specific meanings under this sense.</small></p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- LIFT 0.13: Reversals Section (Day 24-25) -->
                                        <div class="reversals-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-exchange-alt"></i> Reversals</h6>
                                                <button type="button" class="btn btn-sm btn-outline-info add-reversal-btn" 
                                                        data-sense-index="{{ loop.index0 }}"
                                                        title="Add a reversal entry for bilingual dictionaries">
                                                    <i class="fas fa-plus"></i> Add Reversal
                                                </button>
                                            </div>
                                            
                                            <div class="reversals-container ms-3" data-sense-index="{{ loop.index0 }}">
                                                {% if sense.reversals %}
                                                    {% for reversal in sense.reversals %}
                                                        <div class="reversal-item card mb-3 border-info" data-reversal-index="{{ loop.index0 }}">
                                                            <div class="card-header bg-info bg-opacity-10">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span><i class="fas fa-language"></i> Reversal {{ loop.index }}</span>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-reversal-btn"
                                                                            data-sense-index="{{ sense_index }}" data-reversal-index="{{ loop.index0 }}">
                                                                        <i class="fas fa-trash"></i> Remove
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="card-body">
                                                                <!-- Reversal Type (Language) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Type (Language)</label>
                                                                    <select class="form-select reversal-type-select" 
                                                                            name="senses[{{ sense_index }}].reversals[{{ loop.index0 }}].type"
                                                                            data-current-value="{{ reversal.type }}">
                                                                        <option value="">-- Select Language --</option>
                                                                        {% if lift_ranges and lift_ranges.get('reversal-type') %}
                                                                            {% for range_item in lift_ranges['reversal-type'] %}
                                                                                <option value="{{ range_item.id }}" 
                                                                                    {% if reversal.type == range_item.id %}selected{% endif %}>
                                                                                    {{ range_item.label }}
                                                                                </option>
                                                                            {% endfor %}
                                                                        {% endif %}
                                                                    </select>
                                                                </div>
                                                                
                                                                <!-- Reversal Forms (Multitext) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Forms</label>
                                                                    <div class="reversal-forms-container">
                                                                        {% if reversal.forms %}
                                                                            {% for lang, text in reversal.forms.items() %}
                                                                                <div class="input-group mb-2">
                                                                                    <span class="input-group-text">{{ lang }}</span>
                                                                                    <input type="text" class="form-control" 
                                                                                           name="senses[{{ sense_index }}].reversals[{{ loop.index0 }}].forms.{{ lang }}"
                                                                                           value="{{ text }}"
                                                                                           placeholder="Enter text in {{ lang }}">
                                                                                </div>
                                                                            {% endfor %}
                                                                        {% else %}
                                                                            <div class="text-muted"><small>No forms yet</small></div>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Reversal Grammatical Info -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Grammatical Info</label>
                                                                    <select class="form-select" 
                                                                            name="senses[{{ sense_index }}].reversals[{{ loop.index0 }}].grammatical_info">
                                                                        <option value="">-- Select --</option>
                                                                        {% if lift_ranges and lift_ranges.get('grammatical-info') %}
                                                                            {% for range_item in lift_ranges['grammatical-info'] %}
                                                                                <option value="{{ range_item.id }}" 
                                                                                    {% if reversal.grammatical_info == range_item.id %}selected{% endif %}>
                                                                                    {{ range_item.label }}
                                                                                </option>
                                                                            {% endfor %}
                                                                        {% endif %}
                                                                    </select>
                                                                </div>
                                                                
                                                                <!-- Reversal Main Element (Collapsible) -->
                                                                <div class="reversal-main-section">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <label class="form-label mb-0">Main Element</label>
                                                                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-main-btn"
                                                                                data-bs-toggle="collapse" 
                                                                                data-bs-target="#reversal-main-{{ sense_index }}-{{ loop.index0 }}">
                                                                            <i class="fas fa-chevron-down"></i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="collapse {% if reversal.main %}show{% endif %}" 
                                                                         id="reversal-main-{{ sense_index }}-{{ loop.index0 }}">
                                                                        <div class="card bg-light">
                                                                            <div class="card-body">
                                                                                {% if reversal.main %}
                                                                                    <!-- Main Forms -->
                                                                                    <div class="mb-2">
                                                                                        <label class="form-label"><small>Forms</small></label>
                                                                                        {% if reversal.main.forms %}
                                                                                            {% for lang, text in reversal.main.forms.items() %}
                                                                                                <div class="input-group mb-1">
                                                                                                    <span class="input-group-text input-group-text-sm">{{ lang }}</span>
                                                                                                    <input type="text" class="form-control form-control-sm" 
                                                                                                           name="senses[{{ sense_index }}].reversals[{{ loop.index0 }}].main.forms.{{ lang }}"
                                                                                                           value="{{ text }}">
                                                                                                </div>
                                                                                            {% endfor %}
                                                                                        {% endif %}
                                                                                    </div>
                                                                                    
                                                                                    <!-- Main Grammatical Info -->
                                                                                    <div class="mb-2">
                                                                                        <label class="form-label"><small>Grammatical Info</small></label>
                                                                                        <select class="form-select form-select-sm" 
                                                                                                name="senses[{{ sense_index }}].reversals[{{ loop.index0 }}].main.grammatical_info">
                                                                                            <option value="">-- Select --</option>
                                                                                            {% if lift_ranges and lift_ranges.get('grammatical-info') %}
                                                                                                {% for range_item in lift_ranges['grammatical-info'] %}
                                                                                                    <option value="{{ range_item.id }}" 
                                                                                                        {% if reversal.main.grammatical_info == range_item.id %}selected{% endif %}>
                                                                                                        {{ range_item.label }}
                                                                                                    </option>
                                                                                                {% endfor %}
                                                                                            {% endif %}
                                                                                        </select>
                                                                                    </div>
                                                                                {% else %}
                                                                                    <div class="text-muted"><small>No main element configured</small></div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="no-reversals text-center text-muted py-2 border border-info border-opacity-25 rounded">
                                                        <p class="mb-2"><small>No reversals yet. Add reversals for bilingual dictionary support.</small></p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- LIFT 0.13: Annotations Section (Day 26-27) -->
                                        <div class="annotations-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-clipboard-list"></i> Annotations</h6>
                                                <button type="button" class="btn btn-sm btn-outline-warning add-annotation-btn" 
                                                        data-container-type="sense" data-index="{{ loop.index0 }}"
                                                        title="Add an annotation for editorial workflow (review status, comments, etc.)">
                                                    <i class="fas fa-plus"></i> Add Annotation
                                                </button>
                                            </div>
                                            
                                            <div class="annotations-container ms-3" data-container-type="sense" data-index="{{ loop.index0 }}">
                                                {% if sense.annotations %}
                                                    {% for annotation in sense.annotations %}
                                                        <div class="annotation-item card mb-3 border-warning" data-annotation-index="{{ loop.index0 }}">
                                                            <div class="card-header bg-warning bg-opacity-10">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span><i class="fas fa-tag"></i> Annotation {{ loop.index }}</span>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-annotation-btn"
                                                                            data-container-type="sense" data-index="{{ sense_index }}" data-annotation-index="{{ loop.index0 }}">
                                                                        <i class="fas fa-trash"></i> Remove
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="card-body">
                                                                <!-- Annotation Name (required) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Name <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control annotation-name-input" 
                                                                           name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].name"
                                                                           value="{{ annotation.name }}"
                                                                           placeholder="e.g., review-status, comment, flagged"
                                                                           required>
                                                                    <small class="form-text text-muted">
                                                                        Common names: review-status, comment, reviewer-comment, approval-status, flagged, priority, needs-revision
                                                                    </small>
                                                                </div>
                                                                
                                                                <!-- Annotation Value (optional) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Value</label>
                                                                    <input type="text" class="form-control" 
                                                                           name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].value"
                                                                           value="{{ annotation.value }}"
                                                                           placeholder="e.g., approved, pending, rejected">
                                                                </div>
                                                                
                                                                <!-- Annotation Who (optional) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">Who</label>
                                                                    <input type="text" class="form-control" 
                                                                           name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].who"
                                                                           value="{{ annotation.who }}"
                                                                           placeholder="e.g., editor@example.com, John Doe">
                                                                    <small class="form-text text-muted">Person or email who created this annotation (will be auto-filled with username when user management is implemented)</small>
                                                                </div>
                                                                
                                                                <!-- Annotation When (auto-populated) -->
                                                                <div class="mb-3">
                                                                    <label class="form-label">When</label>
                                                                    <input type="datetime-local" class="form-control" 
                                                                           name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].when"
                                                                           value="{{ annotation.when }}"
                                                                           readonly>
                                                                    <small class="form-text text-muted">Timestamp when this annotation was created (auto-generated)</small>
                                                                </div>
                                                                
                                                                <!-- Annotation Content (collapsible) -->
                                                                <div class="annotation-content-section">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <label class="form-label mb-0">Content</label>
                                                                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-content-btn"
                                                                                data-bs-toggle="collapse" 
                                                                                data-bs-target="#annotation-content-{{ sense_index }}-{{ loop.index0 }}">
                                                                            <i class="fas fa-chevron-down"></i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="collapse {% if annotation.content %}show{% endif %}" 
                                                                         id="annotation-content-{{ sense_index }}-{{ loop.index0 }}">
                                                                        <div class="card bg-light">
                                                                            <div class="card-body">
                                                                                <div class="annotation-content-forms">
                                                                                    {% if annotation.content %}
                                                                                        {% for lang, text in annotation.content.items() %}
                                                                                            <div class="input-group mb-2">
                                                                                                <span class="input-group-text">{{ lang }}</span>
                                                                                                <textarea class="form-control" 
                                                                                                       name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].content.{{ lang }}"
                                                                                                       rows="2"
                                                                                                       placeholder="Enter comment or description in {{ lang }}">{{ text }}</textarea>
                                                                                                {% if lang != 'en' %}
                                                                                                <button type="button" class="btn btn-outline-danger remove-annotation-language-btn" title="Remove this language">
                                                                                                    <i class="fas fa-times"></i>
                                                                                                </button>
                                                                                                {% endif %}
                                                                                            </div>
                                                                                        {% endfor %}
                                                                                    {% else %}
                                                                                        <div class="input-group mb-2">
                                                                                            <span class="input-group-text">en</span>
                                                                                            <textarea class="form-control" 
                                                                                                   name="senses[{{ sense_index }}].annotations[{{ loop.index0 }}].content.en"
                                                                                                   rows="2"
                                                                                                   placeholder="Enter comment or description in English"></textarea>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                </div>
                                                                                <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-annotation-language-btn">
                                                                                    <i class="fas fa-plus"></i> Add Language
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="no-annotations text-center text-muted py-2 border border-warning border-opacity-25 rounded">
                                                        <p class="mb-2"><small>No annotations yet. Add annotations for editorial workflow (review status, comments, etc.).</small></p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        {% endfor %}
                        {% else %}
                            <div class="sense-item card mb-4 default-sense-template" data-sense-index="TEMPLATE" id="default-sense-template">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Sense 1</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Definition <span class="text-danger">*</span></label>
                                        <div class="multilingual-forms definition-forms">
                                            {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                            <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Language</label>
                                                        <select class="form-select language-select" 
                                                                name="senses[TEMPLATE].definition.{{ default_lang_code }}.lang"
                                                                data-field-name="senses[TEMPLATE].definition.{{ default_lang_code }}">
                                                            {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                                            {% if default_lang_code not in project_lang_codes %}
                                                                <option value="{{ default_lang_code }}" selected>{{ default_lang_code }} (original)</option>
                                                            {% endif %}
                                                            {% for code, label in project_languages %}
                                                                <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="form-label">Definition Text</label>
                                                        <textarea class="form-control definition-text" 
                                                                  name="senses[TEMPLATE].definition.{{ default_lang_code }}.text"
                                                                  rows="2" 
                                                                  required
                                                                  placeholder="Enter definition in {{ default_lang_code }}"></textarea>
                                                    </div>
                                                    <div class="col-md-1">
                                                        <!-- No remove button for primary language -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                                                    data-sense-index="0"
                                                    title="Add another language">
                                                <i class="fas fa-plus"></i> Add Language
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Gloss</label>
                                        <div class="multilingual-forms gloss-forms">
                                            {% set default_lang_code = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                                            <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Language</label>
                                                        <select class="form-select language-select" 
                                                                name="senses[TEMPLATE].gloss.{{ default_lang_code }}.lang"
                                                                data-field-name="senses[TEMPLATE].gloss.{{ default_lang_code }}">
                                                            {% for code, label in project_languages %}
                                                                <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="form-label">Gloss Text</label>
                                                        <input type="text" class="form-control gloss-text" 
                                                               name="senses[TEMPLATE].gloss.{{ default_lang_code }}.text"
                                                               value=""
                                                               placeholder="Enter gloss in {{ default_lang_code }}">
                                                    </div>
                                                    <div class="col-md-1">
                                                        <!-- No remove button for primary language -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                                                    data-sense-index="0"
                                                    title="Add another language">
                                                <i class="fas fa-plus"></i> Add Language
                                            </button>
                                        </div>
                                        <div class="form-text">A short equivalent in another language.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Part of Speech</label>
                                        <select class="form-select dynamic-grammatical-info" name="senses[TEMPLATE].grammatical_info"
                                                data-range-id="grammatical-info">
                                            <option value="">Select part of speech</option>
                                        </select>
                                        <div class="form-text">Grammatical category for this sense.</div>
                                    </div>
                                    
                                    <!-- LIFT Ranges: Semantic Domain (sense-level) -->
                                    <div class="mb-3">
                                        <label class="form-label">Semantic Domain</label>
                                        <select class="form-select dynamic-lift-range" 
                                                name="senses[TEMPLATE].domain_type" 
                                                data-range-id="semantic-domain-ddp4" 
                                                data-hierarchical="true" 
                                                data-searchable="true"
                                                multiple>
                                            <option value="">Select semantic domain(s)</option>
                                        </select>
                                        <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
                                    </div>
                                    
                                    <!-- LIFT Ranges: Usage Type (sense-level) -->
                                    <div class="mb-3">
                                        <label class="form-label">Usage Type</label>
                                        <select class="form-select dynamic-lift-range" 
                                                name="senses[TEMPLATE].usage_type" 
                                                data-range-id="usage-type"
                                                data-hierarchical="true"
                                                data-searchable="true"
                                                multiple>
                                            <option value="">Select usage type(s)</option>
                                        </select>
                                        <div class="form-text">Usage classification for this sense (can select multiple).</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Sense Note</label>
                                        <textarea class="form-control" name="senses[TEMPLATE].note" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="examples-section mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6><i class="fas fa-quote-left"></i> Examples</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                    data-sense-index="0">
                                                <i class="fas fa-plus"></i> Add Example
                                            </button>
                                        </div>
                                        
                                        <div class="examples-container">
                                            <div class="no-examples text-center text-muted py-3 border rounded">
                                                <p>No examples added yet</p>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                                        data-sense-index="0">
                                                    <i class="fas fa-plus"></i> Add Example
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-center mt-3" id="no-senses-message" style="display: none;">
                        <p class="text-muted">No senses added yet</p>
                        <button type="button" class="btn btn-primary" id="add-first-sense-btn">
                            <i class="fas fa-plus"></i> Add First Sense
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- LIFT 0.13: Entry-Level Annotations Section (Day 26-27) -->
            <div class="card mt-4 annotations-section-entry">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Entry Annotations</h5>
                        <button type="button" class="btn btn-sm btn-outline-warning add-annotation-btn" 
                                data-container-type="entry" data-index="0"
                                title="Add an annotation for editorial workflow (review status, comments, etc.)">
                            <i class="fas fa-plus"></i> Add Annotation
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="annotations-container" data-container-type="entry" data-index="0">
                        {% if entry.annotations %}
                            {% for annotation in entry.annotations %}
                                <div class="annotation-item card mb-3 border-warning" data-annotation-index="{{ loop.index0 }}">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-tag"></i> Annotation {{ loop.index }}</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-annotation-btn"
                                                    data-container-type="entry" data-index="0" data-annotation-index="{{ loop.index0 }}">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Annotation Name (required) -->
                                        <div class="mb-3">
                                            <label class="form-label">Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control annotation-name-input" 
                                                   name="annotations[{{ loop.index0 }}].name"
                                                   value="{{ annotation.name }}"
                                                   placeholder="e.g., review-status, comment, flagged"
                                                   required>
                                            <small class="form-text text-muted">
                                                Common names: review-status, comment, reviewer-comment, approval-status, flagged, priority, needs-revision
                                            </small>
                                        </div>
                                        
                                        <!-- Annotation Value (optional) -->
                                        <div class="mb-3">
                                            <label class="form-label">Value</label>
                                            <input type="text" class="form-control" 
                                                   name="annotations[{{ loop.index0 }}].value"
                                                   value="{{ annotation.value }}"
                                                   placeholder="e.g., approved, pending, rejected">
                                        </div>
                                        
                                        <!-- Annotation Who (optional) -->
                                        <div class="mb-3">
                                            <label class="form-label">Who</label>
                                            <input type="text" class="form-control" 
                                                   name="annotations[{{ loop.index0 }}].who"
                                                   value="{{ annotation.who }}"
                                                   placeholder="e.g., editor@example.com, John Doe">
                                            <small class="form-text text-muted">Person or email who created this annotation (will be auto-filled with username when user management is implemented)</small>
                                        </div>
                                        
                                        <!-- Annotation When (auto-populated) -->
                                        <div class="mb-3">
                                            <label class="form-label">When</label>
                                            <input type="datetime-local" class="form-control" 
                                                   name="annotations[{{ loop.index0 }}].when"
                                                   value="{{ annotation.when }}"
                                                   readonly>
                                            <small class="form-text text-muted">Timestamp when this annotation was created (auto-generated)</small>
                                        </div>
                                        
                                        <!-- Annotation Content (collapsible) -->
                                        <div class="annotation-content-section">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0">Content</label>
                                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-content-btn"
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#annotation-content-entry-{{ loop.index0 }}">
                                                    <i class="fas fa-chevron-down"></i>
                                                </button>
                                            </div>
                                            <div class="collapse {% if annotation.content %}show{% endif %}" 
                                                 id="annotation-content-entry-{{ loop.index0 }}">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <div class="annotation-content-forms">
                                                            {% if annotation.content %}
                                                                {% for lang, text in annotation.content.items() %}
                                                                    <div class="input-group mb-2">
                                                                        <span class="input-group-text">{{ lang }}</span>
                                                                        <textarea class="form-control" 
                                                                               name="annotations[{{ loop.index0 }}].content.{{ lang }}"
                                                                               rows="2"
                                                                               placeholder="Enter comment or description in {{ lang }}">{{ text }}</textarea>
                                                                        {% if lang != 'en' %}
                                                                        <button type="button" class="btn btn-outline-danger remove-annotation-language-btn" title="Remove this language">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% else %}
                                                                <div class="input-group mb-2">
                                                                    <span class="input-group-text">en</span>
                                                                    <textarea class="form-control" 
                                                                           name="annotations[{{ loop.index0 }}].content.en"
                                                                           rows="2"
                                                                           placeholder="Enter comment or description in English"></textarea>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-annotation-language-btn">
                                                            <i class="fas fa-plus"></i> Add Language
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-annotations text-center text-muted py-3 border border-warning border-opacity-25 rounded">
                                <p class="mb-2"><small>No entry-level annotations yet. Add annotations for editorial workflow (review status, comments, etc.).</small></p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- XML Preview Panel (Debug Mode) -->
            <div class="card mt-4 mb-3" id="xml-preview-panel" style="display: none;">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-code"></i> Generated LIFT XML</h6>
                        <button type="button" class="btn btn-sm btn-light" id="copy-xml-btn" title="Copy XML to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <pre id="xml-preview-content" class="mb-0 p-3" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; background-color: #f8f9fa;"></pre>
                </div>
                <div class="card-footer">
                    <small class="text-muted">This is the XML that will be sent to the server</small>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" id="toggle-xml-preview-btn" title="Show/Hide XML Preview">
                                <i class="fas fa-code"></i> XML Preview
                            </button>
                            <button type="button" class="btn btn-primary" id="validate-btn">
                                <i class="fas fa-check-circle"></i> Validate
                            </button>
                            <button type="submit" class="btn btn-success" id="save-btn">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                            <div class="form-check form-check-inline ms-3">
                                <input class="form-check-input" type="checkbox" id="skip-validation-checkbox">
                                <label class="form-check-label" for="skip-validation-checkbox">
                                    <small>Skip validation (save partial work)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Templates for JavaScript -->
<template id="pronunciation-template">
    <div class="pronunciation-item mb-3 border-bottom pb-3">
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">IPA</label>
                <input type="text" class="form-control ipa-input" name="pronunciations[INDEX].value" 
                       value="" placeholder="IPA transcription">
            </div>
            <div class="col-md-4">
                <label class="form-label">Type</label>
                <input type="hidden" name="pronunciations[INDEX].type" value="seh-fonipa">
                <input type="text" class="form-control" value="seh-fonipa" disabled
                       title="Only seh-fonipa is supported for IPA pronunciations">
                <div class="form-text">International Phonetic Alphabet (IPA)</div>
            </div>
        </div>
        
        <div class="mt-2 mb-2">
            <label class="form-label">Audio File</label>
            <div class="input-group">
                <input type="text" class="form-control" name="pronunciations[INDEX].audio_path" 
                       value="" readonly placeholder="No audio file">
                <button class="btn btn-outline-secondary upload-audio-btn" type="button" 
                        data-index="INDEX" title="Upload audio file">
                    <i class="fas fa-upload"></i> Upload
                </button>
                <button class="btn btn-outline-secondary generate-audio-btn" type="button" 
                        data-index="INDEX" title="Generate audio from IPA">
                    <i class="fas fa-magic"></i> Generate
                </button>
            </div>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" 
                   id="pron-default-INDEX" name="pronunciations[INDEX].is_default">
            <label class="form-check-label" for="pron-default-INDEX">
                Default pronunciation
            </label>
        </div>
        
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-danger remove-pronunciation-btn" 
                    data-index="INDEX">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    </div>
</template>

<template id="sense-template">
    <div class="sense-item card mb-4" data-sense-index="INDEX">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="drag-handle me-2" title="Drag to reorder" style="cursor: grab;">
                        <i class="fas fa-grip-vertical text-muted"></i>
                    </div>
                    <h6 class="mb-0">Sense NUMBER</h6>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-secondary move-sense-up" title="Move Up"></button>
                    <button type="button" class="btn btn-sm btn-secondary move-sense-down" title="Move Down"></button>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-sense-btn" 
                            data-index="INDEX">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Hidden field for sense ID (will be populated when adding new senses) -->
            <input type="hidden" name="senses[INDEX].id" value="">
            
            <div class="mb-3">
                <label class="form-label">Definition <span class="text-danger">*</span></label>
                <div class="multilingual-forms definition-forms">
                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Language</label>
                                <select class="form-select language-select" 
                                        name="senses[INDEX].definition.{{ default_lang_code }}.lang"
                                        data-field-name="senses[INDEX].definition.{{ default_lang_code }}">
                                    {% set project_lang_codes = project_languages|map(attribute=0)|list %}
                                    {% if default_lang_code not in project_lang_codes %}
                                        <option value="{{ default_lang_code }}" selected>{{ default_lang_code }} (original)</option>
                                    {% endif %}
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Definition Text</label>
                                <textarea class="form-control definition-text" 
                                          name="senses[INDEX].definition.{{ default_lang_code }}.text"
                                          rows="2" 
                                          required
                                          placeholder="Enter definition in {{ default_lang_code }}"></textarea>
                            </div>
                            <div class="col-md-1">
                                <!-- No remove button for primary language -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary add-definition-language-btn" 
                            data-sense-index="INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Gloss</label>
                <div class="multilingual-forms gloss-forms">
                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-3 language-form" data-language="{{ default_lang_code }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Language</label>
                                <select class="form-select language-select" 
                                        name="senses[INDEX].gloss.{{ default_lang_code }}.lang"
                                        data-field-name="senses[INDEX].gloss.{{ default_lang_code }}">
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Gloss Text</label>
                                <input type="text" class="form-control gloss-text" 
                                       name="senses[INDEX].gloss.{{ default_lang_code }}.text"
                                       value=""
                                       placeholder="Enter gloss in {{ default_lang_code }}">
                            </div>
                            <div class="col-md-1">
                                <!-- No remove button for primary language -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary add-gloss-language-btn" 
                            data-sense-index="INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
                <div class="form-text">A short equivalent in another language.</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Part of Speech</label>
                <select class="form-select dynamic-grammatical-info" name="senses[INDEX].grammatical_info"
                        data-range-id="grammatical-info"
                        data-hierarchical="true"
                        data-searchable="true">
                    <option value="">Select part of speech</option>
                </select>
            </div>

            <!-- LIFT Ranges: Academic Domain (sense-level) -->
            <div class="mb-3">
                <label class="form-label">Academic Domain</label>
                <select class="form-select dynamic-lift-range" name="senses[INDEX].academic_domain"
                        data-range-id="academic-domain"
                        data-hierarchical="true"
                        data-searchable="true">
                    <option value="">Select academic domain</option>
                </select>
                <div class="form-text">Academic or disciplinary domain this sense belongs to.</div>
            </div>

            <!-- LIFT Ranges: Semantic Domain (sense-level) -->
            <div class="mb-3">
                <label class="form-label">Semantic Domain</label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[INDEX].domain_type" 
                        data-range-id="semantic-domain-ddp4" 
                        data-hierarchical="true" 
                        data-searchable="true"
                        multiple>
                    <option value="">Select semantic domain(s)</option>
                </select>
                <div class="form-text">Semantic categorization for this sense (can select multiple).</div>
            </div>
            
            <!-- LIFT Ranges: Usage Type (sense-level) -->
            <div class="mb-3">
                <label class="form-label">Usage Type</label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[INDEX].usage_type" 
                        data-range-id="usage-type"
                        data-hierarchical="true"
                        data-searchable="true"
                        multiple>
                    <option value="">Select usage type(s)</option>
                </select>
                <div class="form-text">Usage classification for this sense (can select multiple).</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Sense Note</label>
                <textarea class="form-control" name="senses[INDEX].note" rows="2"></textarea>
            </div>
            
            <div class="examples-section mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-quote-left"></i> Examples</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                            data-sense-index="INDEX">
                        <i class="fas fa-plus"></i> Add Example
                    </button>
                </div>
                
                <div class="examples-container">
                    <div class="no-examples text-center text-muted py-3 border rounded">
                        <p>No examples added yet</p>
                        <button type="button" class="btn btn-sm btn-outline-primary add-example-btn" 
                                data-sense-index="INDEX">
                            <i class="fas fa-plus"></i> Add Example
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="example-template">
    <div class="example-item card mb-3">
        <div class="card-header bg-light py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small>Example NUMBER</small>
                <button type="button" class="btn btn-sm btn-outline-danger remove-example-btn" 
                        data-sense-index="SENSE_INDEX" data-example-index="EXAMPLE_INDEX">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <label class="form-label">Example Text <span class="text-danger">*</span></label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].text" 
                          rows="2" required></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Translation</label>
                <textarea class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].translation" 
                          rows="2"></textarea>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Translation Type
                    <span class="input-group-text border-0 bg-transparent p-0 ms-1">
                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Specify the type of translation: 'literal' for word-for-word translation, 'free' for natural/idiomatic translation."></i>
                    </span>
                </label>
                <select class="form-select dynamic-lift-range" 
                        name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].translation_type"
                        data-range-id="translation-type"
                        data-hierarchical="false"
                        data-searchable="true">
                    <option value="">Select translation type</option>
                    <option value="literal">Literal</option>
                    <option value="free">Free/Idiomatic</option>
                </select>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Reference</label>
                <input type="text" class="form-control" name="senses[SENSE_INDEX].examples[EXAMPLE_INDEX].reference" 
                       value="">
            </div>
        </div>
    </div>
</template>

<!-- Subsense Template (LIFT 0.13 - Day 22) -->
<template id="subsense-template">
    <div class="subsense-item card mb-3 border-success" data-subsense-index="SUBSENSE_INDEX">
        <div class="card-header bg-success bg-opacity-10 py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small><i class="fas fa-level-down-alt"></i> Subsense NUMBER</small>
                <button type="button" class="btn btn-sm btn-outline-danger remove-subsense-btn" 
                        data-sense-index="SENSE_INDEX" data-subsense-index="SUBSENSE_INDEX">
                    <i class="fas fa-times"></i> Remove
                </button>
            </div>
        </div>
        <div class="card-body p-3">
            <!-- Hidden subsense ID -->
            <input type="hidden" name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].id" value="">
            
            <!-- Subsense Definition (multilingual) -->
            <div class="mb-3">
                <label class="form-label">Definition <span class="text-danger">*</span></label>
                <div class="multilingual-forms definition-forms">
                    {% set default_lang_code = current_app.config.PROJECT_SETTINGS.source_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-2 language-form" data-language="{{ default_lang_code }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label small">Language</label>
                                <select class="form-select form-select-sm language-select" 
                                        name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].definition.{{ default_lang_code }}.lang"
                                        data-field-name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].definition.{{ default_lang_code }}">
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_lang_code %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label small">Definition Text</label>
                                <textarea class="form-control form-control-sm definition-text" 
                                          name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].definition.{{ default_lang_code }}.text"
                                          rows="2" 
                                          required
                                          placeholder="Enter more specific definition"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-1">
                    <button type="button" class="btn btn-sm btn-outline-primary add-subsense-definition-language-btn" 
                            data-sense-index="SENSE_INDEX" data-subsense-index="SUBSENSE_INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
            </div>
            
            <!-- Subsense Gloss (multilingual) -->
            <div class="mb-3">
                <label class="form-label">Gloss</label>
                <div class="multilingual-forms gloss-forms">
                    {% set default_gloss_lang = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="mb-2 language-form" data-language="{{ default_gloss_lang }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label small">Language</label>
                                <select class="form-select form-select-sm language-select" 
                                        name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].gloss.{{ default_gloss_lang }}.lang"
                                        data-field-name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].gloss.{{ default_gloss_lang }}">
                                    {% for code, label in project_languages %}
                                        <option value="{{ code }}" {% if code == default_gloss_lang %}selected{% endif %}>{{ label|safe }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label small">Gloss Text</label>
                                <input type="text" class="form-control form-control-sm gloss-text" 
                                       name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].gloss.{{ default_gloss_lang }}.text"
                                       placeholder="Enter short equivalent">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-1">
                    <button type="button" class="btn btn-sm btn-outline-primary add-subsense-gloss-language-btn" 
                            data-sense-index="SENSE_INDEX" data-subsense-index="SUBSENSE_INDEX"
                            title="Add another language">
                        <i class="fas fa-plus"></i> Add Language
                    </button>
                </div>
            </div>
            
            <!-- Subsense Grammatical Info -->
            <div class="mb-3">
                <label class="form-label">Part of Speech</label>
                <select class="form-select form-select-sm dynamic-grammatical-info" 
                        name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].grammatical_info"
                        data-range-id="grammatical-info">
                    <option value="">Select part of speech</option>
                </select>
            </div>
            
            <!-- Subsense Note -->
            <div class="mb-2">
                <label class="form-label">Note</label>
                <textarea class="form-control form-control-sm" 
                          name="senses[SENSE_INDEX].subsenses[SUBSENSE_INDEX].note" 
                          rows="2"
                          placeholder="Additional notes about this subsense"></textarea>
            </div>
            
            <!-- Nested Subsenses Support (Recursive) -->
            <div class="mt-3 p-2 border-start border-success border-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted"><i class="fas fa-sitemap"></i> Nested Subsenses</small>
                    <button type="button" class="btn btn-sm btn-outline-success add-nested-subsense-btn" 
                            data-sense-index="SENSE_INDEX" data-subsense-index="SUBSENSE_INDEX"
                            title="Add even more specific meaning">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="nested-subsenses-container" data-parent-subsense="SUBSENSE_INDEX">
                    <small class="text-muted">No nested subsenses yet</small>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- LIFT 0.13: Reversal Template (Day 24-25) -->
<template id="reversal-template">
    <div class="reversal-item card mb-3 border-info" data-reversal-index="REVERSAL_INDEX">
        <div class="card-header bg-info bg-opacity-10 py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small><i class="fas fa-language"></i> Reversal NUMBER</small>
                <button type="button" class="btn btn-sm btn-outline-danger remove-reversal-btn" 
                        data-sense-index="SENSE_INDEX" data-reversal-index="REVERSAL_INDEX">
                    <i class="fas fa-times"></i> Remove
                </button>
            </div>
        </div>
        <div class="card-body p-3">
            <!-- Reversal Type (Language) -->
            <div class="mb-3">
                <label class="form-label">Type (Language)</label>
                <select class="form-select reversal-type-select dynamic-reversal-type" 
                        name="senses[SENSE_INDEX].reversals[REVERSAL_INDEX].type">
                    <option value="">-- Select Language --</option>
                </select>
            </div>
            
            <!-- Reversal Forms (Multitext) -->
            <div class="mb-3">
                <label class="form-label">Forms</label>
                <div class="reversal-forms-container">
                    {% set default_lang = current_app.config.PROJECT_SETTINGS.target_language.code if current_app and current_app.config.PROJECT_SETTINGS else 'en' %}
                    <div class="input-group mb-2">
                        <span class="input-group-text">{{ default_lang }}</span>
                        <input type="text" class="form-control" 
                               name="senses[SENSE_INDEX].reversals[REVERSAL_INDEX].forms.{{ default_lang }}"
                               placeholder="Enter text in {{ default_lang }}">
                    </div>
                </div>
            </div>
            
            <!-- Reversal Grammatical Info -->
            <div class="mb-3">
                <label class="form-label">Grammatical Info</label>
                <select class="form-select dynamic-grammatical-info" 
                        name="senses[SENSE_INDEX].reversals[REVERSAL_INDEX].grammatical_info">
                    <option value="">-- Select --</option>
                </select>
            </div>
            
            <!-- Reversal Main Element (Collapsible) -->
            <div class="reversal-main-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Main Element (Optional)</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary toggle-main-btn"
                            data-bs-toggle="collapse" 
                            data-bs-target="#reversal-main-SENSE_INDEX-REVERSAL_INDEX">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse" id="reversal-main-SENSE_INDEX-REVERSAL_INDEX">
                    <div class="card bg-light">
                        <div class="card-body p-2">
                            <!-- Main Forms -->
                            <div class="mb-2">
                                <label class="form-label"><small>Forms</small></label>
                                <div class="input-group mb-1">
                                    <span class="input-group-text input-group-text-sm">{{ default_lang }}</span>
                                    <input type="text" class="form-control form-control-sm" 
                                           name="senses[SENSE_INDEX].reversals[REVERSAL_INDEX].main.forms.{{ default_lang }}"
                                           placeholder="Enter main form">
                                </div>
                            </div>
                            
                            <!-- Main Grammatical Info -->
                            <div class="mb-2">
                                <label class="form-label"><small>Grammatical Info</small></label>
                                <select class="form-select form-select-sm dynamic-grammatical-info" 
                                        name="senses[SENSE_INDEX].reversals[REVERSAL_INDEX].main.grammatical_info">
                                    <option value="">-- Select --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Validation Error Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="validationModalLabel">Validation Errors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="validation-errors-list">
                    <!-- Errors will be populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Select2 for enhanced dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- LIFT XML Serializer -->
<script src="{{ url_for('static', filename='js/lift-xml-serializer.js') }}"></script>
<!-- Form serialization utilities -->
<script src="{{ url_for('static', filename='js/form-serializer.js') }}"></script>
<!-- Form state management -->
<script src="{{ url_for('static', filename='js/form-state-manager.js') }}"></script>
<!-- Client validation -->
<script src="{{ url_for('static', filename='js/client-validation-engine.js') }}"></script>
<!-- Auto-save functionality -->
<script src="{{ url_for('static', filename='js/auto-save-manager.js') }}"></script>
<!-- Validation UI -->
<script src="{{ url_for('static', filename='js/validation-ui.js') }}"></script>
<!-- Inline validation -->
<script src="{{ url_for('static', filename='js/inline-validation.js') }}"></script>
<!-- Ranges loader -->
<script src="{{ url_for('static', filename='js/ranges-loader.js') }}"></script>
<!-- SortableJS for drag-and-drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Pronunciation management -->
<script src="{{ url_for('static', filename='js/pronunciation-forms.js') }}"></script>
<!-- Variant relationships management -->
<script src="{{ url_for('static', filename='js/variant-forms.js') }}"></script>
<!-- Relations management -->
<script src="{{ url_for('static', filename='js/relations.js') }}"></script>
<!-- Etymology management -->
<script src="{{ url_for('static', filename='js/etymology-forms.js') }}"></script>
<!-- Multilingual fields management -->
<script src="{{ url_for('static', filename='js/multilingual-sense-fields.js') }}"></script>
<!-- Sense relation search functionality -->
<script src="{{ url_for('static', filename='js/sense-relation-search.js') }}"></script>
<!-- Component search functionality -->
<script src="{{ url_for('static', filename='js/component-search.js') }}"></script>
<!-- Reordering manager for multi-item lists -->
<script src="{{ url_for('static', filename='js/reordering-manager.js') }}"></script>
<!-- Entry form functionality (must be last) -->
<script src="{{ url_for('static', filename='js/entry-form.js') }}"></script>

<script>
// Make ranges data available to JavaScript
window.rangesData = {{ ranges | tojson | safe }};

document.addEventListener('DOMContentLoaded', async function() {
     // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    
    // Note: Range selects are automatically populated by ranges-loader.js
    // No manual range loading needed - just ensure data-range-id attributes are set
    
    // Initialize component managers after DOM is loaded
    
    // Initialize pronunciation manager (if it exists)
    if (window.PronunciationFormsManager && document.getElementById('pronunciation-container')) {
        // Initialize the manager without data. It should attach listeners to existing items.
        window.pronunciationFormsManager = new PronunciationFormsManager('pronunciation-container');
    }

    // Initialize variant forms manager
    if (window.VariantFormsManager && document.getElementById('variants-container')) {
        window.variantFormsManager = new VariantFormsManager('variants-container', {
            variantRelations: {{ (variant_relations | default([])) | tojson | safe }}
        });
    }

    // Initialize relations manager
    if (window.RelationsManager && document.getElementById('relations-container')) {
        window.relationsManager = new RelationsManager('relations-container');
    }

    // Initialize etymology forms manager
    if (window.EtymologyFormsManager && document.getElementById('etymology-container')) {
        window.etymologyFormsManager = new EtymologyFormsManager('etymology-container', {
            rangeId: 'etymology'
        });
    }

    // Initialize multilingual notes manager
    if (window.MultilingualNotesManager && document.getElementById('notes-container')) {
        window.multilingualNotesManager = new MultilingualNotesManager('notes-container');
    }
    
    // Initialize SortableJS for senses    
    const sensesContainer = document.getElementById('senses-container');
    if (sensesContainer && typeof Sortable !== 'undefined') {
        new Sortable(sensesContainer, {
            animation: 150,
            handle: '.drag-handle',  //  Use specific drag handle
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function(evt) {
                // Change cursor during drag
                document.body.style.cursor = 'grabbing';
            },
            onEnd: function (evt) {
                // Reset cursor
                document.body.style.cursor = '';
                // Reindex senses
                if (typeof reindexSenses === 'function') {
                    reindexSenses();
                }
            }
        });
    }   
});
</script>

<!-- Field Visibility Settings Modal -->
<div class="modal fade" id="fieldVisibilityModal" tabindex="-1" aria-labelledby="fieldVisibilityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldVisibilityModalLabel">
                    <i class="fas fa-cog"></i> Field Visibility Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Control which field sections are visible in the entry form. Settings are saved automatically.
                </p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Main Sections</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-basic-info" 
                                   data-target=".basic-info-section" checked>
                            <label class="form-check-label" for="show-basic-info">Basic Information</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-custom-fields" 
                                   data-target=".custom-fields-section" checked>
                            <label class="form-check-label" for="show-custom-fields">Custom Fields</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-notes" 
                                   data-target=".notes-section" checked>
                            <label class="form-check-label" for="show-notes">Entry Notes</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-pronunciation" 
                                   data-target=".pronunciation-section" checked>
                            <label class="form-check-label" for="show-pronunciation">Pronunciation</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Content Sections</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-variants" 
                                   data-target=".variants-section" checked>
                            <label class="form-check-label" for="show-variants">Variants</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-relations" 
                                   data-target=".relations-section" checked>
                            <label class="form-check-label" for="show-relations">Relations</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input field-visibility-toggle" type="checkbox" id="show-senses" 
                                   data-target=".senses-section" checked>
                            <label class="form-check-label" for="show-senses">Senses & Definitions</label>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="reset-field-visibility">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary" id="hide-empty-sections">
                            <i class="fas fa-eye-slash"></i> Hide Empty Sections
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="show-all-sections">
                            <i class="fas fa-eye"></i> Show All Sections
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
